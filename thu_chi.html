<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phi·∫øu Thu - Chi</title>
    
    <!-- Th∆∞ vi·ªán t·∫°o PDF v√† ·∫¢nh -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
   <style>
    @import url('https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap');
    
    :root {
        --page-width: 190mm; /* Kh·ªï A4 chi·ªÅu ngang n·ªôi dung */
        --main-color: #212529;
        --blue-accent: #0d6efd;
    }

    body { 
        font-family: 'Be Vietnam Pro', sans-serif; 
        font-size: 10pt; /* C·ª° ch·ªØ to h∆°n h·ª£p ƒë·ªìng ch√∫t cho d·ªÖ nh√¨n phi·∫øu */
        line-height: 1.5; 
        color: var(--main-color); 
        background-color: #f0f2f5; 
        margin: 0; 
        padding: 0; 
    }
    
    /* --- Action Bar (Thanh c√¥ng c·ª•) --- */
    .actions-container { 
        position: sticky; top: 0; display: flex; justify-content: flex-end; align-items: center;
        width: 100%; background-color: #343a40; padding: 10px 20px; box-sizing: border-box;
        z-index: 2000; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .action-btn { 
        background-color: var(--blue-accent); color: white; border: none; padding: 8px 16px; border-radius: 4px; 
        font-size: 13px; font-weight: 500; cursor: pointer; margin-left: 10px; transition: 0.2s;
    }
    .action-btn:hover { opacity: 0.9; }
    .btn-print { background-color: #6c757d; }
    .btn-pdf { background-color: #198754; }
    .btn-img { background-color: #fd7e14; }

    /* --- Page Container --- */
    .page-wrapper { display: flex; justify-content: center; padding: 30px 0; }
    .voucher-paper { 
        width: var(--page-width); 
        min-height: 130mm; /* Chi·ªÅu cao kho·∫£ng n·ª≠a t·ªù A4 (A5 Landscape) */
        background-color: white; 
        margin: 0 auto; 
        padding: 40px 50px;
        box-shadow: 0 0 15px rgba(0,0,0,0.1);
        box-sizing: border-box;
        position: relative;
    }

    /* --- Header --- */
    .header { display: flex; justify-content: space-between; margin-bottom: 25px; }
    .header-left { display: flex; gap: 15px; width: 75%; }
    .logo-box { width: 80px; height: 80px; flex-shrink: 0; }
    .logo-box img { width: 100%; height: 100%; object-fit: contain; }
    
    .company-info h2 { margin: 0 0 5px 0; font-size: 12pt; text-transform: uppercase; letter-spacing: 0.5px; }
    .company-info p { margin: 2px 0; font-size: 9pt; color: #555; }
    .company-info a { color: var(--blue-accent); text-decoration: none; }

    .header-right { text-align: right; width: 25%; display: flex; flex-direction: column; align-items: flex-end; }
    .qr-box { width: 70px; height: 70px; margin-bottom: 5px; }
    .qr-box img { width: 100%; height: 100%; }
    .meta-text { font-size: 8pt; color: #777; font-style: italic; }

    /* --- Title --- */
    .voucher-title { text-align: center; margin-bottom: 25px; }
    .voucher-title h1 { margin: 0; font-size: 22pt; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
    .voucher-title .date-line { font-style: italic; font-size: 10pt; margin-top: 5px; color: #444; }
    
    .voucher-number-info { 
        position: absolute; 
        top: 140px; 
        right: 50px; 
        text-align: left; 
        font-size: 10pt;
        line-height: 1.4;
    }

    /* --- Content Form --- */
    .form-content { margin-bottom: 30px; }
    .form-row { display: flex; margin-bottom: 12px; align-items: baseline; }
    .form-label { min-width: 130px; font-weight: 600; color: #333; }
    .form-value { flex-grow: 1; border-bottom: 1px dotted #999; padding-bottom: 2px; color: #000; font-weight: 500;}
    .form-value.highlight { font-weight: 700; font-size: 11pt; }
    
    .money-row { align-items: center; }
    .money-value { font-size: 13pt; font-weight: 700; color: #212529; }
    
    .inline-group { display: flex; width: 100%; gap: 30px; }
    .inline-item { display: flex; flex-grow: 1; }

    /* --- Signatures --- */
    .signature-section { 
        display: flex; 
        justify-content: space-between; 
        text-align: center; 
        margin-top: 40px;
    }
    .sig-block { flex: 1; }
    .sig-title { font-weight: 700; font-size: 10pt; text-transform: uppercase; margin-bottom: 4px; }
    .sig-note { font-style: italic; font-size: 8.5pt; color: #666; margin-top: 0; }
    .sig-space { height: 80px; }
    .sig-name { font-weight: 600; font-size: 10pt; }

    /* --- Utilities --- */
    .dynamic-data { color: #000; } /* D·ªØ li·ªáu ƒë·ªông m√†u ƒëen cho trang tr·ªçng */
    
    /* --- Print Styles --- */
    @media print {
        body { background: none; }
        .actions-container { display: none; }
        .page-wrapper { padding: 0; display: block; }
        .voucher-paper { 
            box-shadow: none; margin: 0; width: 100%; height: auto; padding: 20px; 
            page-break-inside: avoid;
        }
        @page { size: A4; margin: 10mm; }
    }
</style>
</head>
<body>

    <!-- Thanh c√¥ng c·ª• -->
    <div class="actions-container">
        <button onclick="window.print()" class="action-btn btn-print">üñ®Ô∏è In Phi·∫øu</button>
        <button onclick="downloadPDF()" class="action-btn btn-pdf">üìÑ T·∫£i PDF</button>
        <button onclick="downloadImage()" class="action-btn btn-img">üñºÔ∏è T·∫£i ·∫¢nh</button>
    </div>

    <div class="page-wrapper">
        <div class="voucher-paper" id="voucher-content">
            
            <!-- Header -->
            <div class="header">
                <div class="header-left">
                    <div class="logo-box">
                        <!-- Logo Studio (thay link ·∫£nh c·ªßa b·∫°n v√†o ƒë√¢y) -->
                        <img src="https://2hstudio.vn/wp-content/uploads/2024/10/8.jpg" alt="Logo" onerror="this.style.display='none'">
                    </div>
                    <div class="company-info">
                        <h2 id="studio-name">2H STUDIO</h2>
                        <p>ƒê·ªãa ch·ªâ: <span id="studio-address">111 Ho√†ng C·∫ßu</span></p>
                        <p>Website: <a href="#" id="studio-website">http://www.2hstudio.vn/</a></p>
                        <p>Fanpage: <span id="studio-fanpage">2Hwedding</span></p>
                        <p>Email: <span id="studio-email">2hstudio.net@gmail.com</span></p>
                        <p>ƒêi·ªán tho·∫°i: <span id="studio-phone">0826268111</span> - Zalo: <span id="studio-zalo">2H Studio</span></p>
                    </div>
                </div>
                <div class="header-right">
                    <div id="qr-code-box" class="qr-box"></div>
                    <div class="meta-text">M√£ phi·∫øu: <span id="ma-phieu"></span></div>
                </div>
            </div>

            <!-- Title -->
            <div class="voucher-title">
                <h1 id="voucher-header-text">PHI·∫æU THU</h1>
                <div class="date-line" id="date-string">Ng√†y ... th√°ng ... nƒÉm ...</div>
            </div>

            <!-- S·ªë phi·∫øu (Quy·ªÉn s·ªë / S·ªë) -->
            <div class="voucher-number-info">
                <div>Quy·ªÉn s·ªë: .................</div>
                <div>S·ªë: ...........................</div>
            </div>

            <!-- Content -->
            <div class="form-content">
                <div class="form-row">
                    <!-- N·∫øu l√† Chi th√¨ l√† Ng∆∞·ªùi nh·∫≠n ti·ªÅn, Thu l√† Ng∆∞·ªùi n·ªôp ti·ªÅn -->
                    <span class="form-label" id="label-doi-tuong">Ng∆∞·ªùi n·ªôp ti·ªÅn :</span>
                    <span class="form-value highlight" id="doi-tuong"></span>
                </div>

                <div class="form-row">
                    <span class="form-label">ƒê·ªãa ch·ªâ :</span>
                    <span class="form-value" id="dia-chi"></span>
                </div>

                <div class="form-row">
                    <span class="form-label">N·ªôi dung :</span>
                    <span class="form-value" id="noi-dung"></span>
                </div>

                <div class="form-row">
                    <div class="inline-group">
                        <div class="inline-item" style="flex: 1;">
                            <span class="form-label" style="min-width: 90px;">H√¨nh th·ª©c :</span>
                            <span class="form-value" id="hinh-thuc"></span>
                        </div>
                        <div class="inline-item" style="flex: 1.5;">
                            <!-- N·∫øu l√† Chuy·ªÉn kho·∫£n s·∫Ω hi·ªán STK, n·∫øu Ti·ªÅn m·∫∑t c√≥ th·ªÉ ·∫©n -->
                            <span class="form-label" style="min-width: 50px;">STK :</span>
                            <span class="form-value" id="so-tai-khoan"></span>
                        </div>
                    </div>
                </div>

                <div class="form-row money-row">
                    <span class="form-label">S·ªë ti·ªÅn :</span>
                    <span class="form-value money-value" id="so-tien-so">0</span>
                </div>

                <div class="form-row">
                    <span class="form-label">B·∫±ng ch·ªØ :</span>
                    <span class="form-value" id="so-tien-chu" style="font-style: italic;">Kh√¥ng ƒë·ªìng</span>
                </div>
                
                <div class="form-row" id="row-kem-theo" style="display: none;">
                    <span class="form-label">K√®m theo :</span>
                    <span class="form-value" id="kem-theo"></span>
                </div>
            </div>

            <!-- Signatures -->
            <div class="signature-section">
                <div class="sig-block">
                    <div class="sig-title">Gi√°m ƒë·ªëc</div>
                    <p class="sig-note">(K√Ω, h·ªç t√™n, ƒë√≥ng d·∫•u)</p>
                    <div class="sig-space"></div>
                    <div class="sig-name"></div>
                </div>
                
                <div class="sig-block">
                    <div class="sig-title">Ng∆∞·ªùi l·∫≠p phi·∫øu</div>
                    <p class="sig-note">(K√Ω, h·ªç t√™n)</p>
                    <div class="sig-space"></div>
                    <div class="sig-name" id="nguoi-lap-phieu"></div>
                </div>

                <div class="sig-block">
                    <!-- Thu: Ng∆∞·ªùi nh·∫≠n ti·ªÅn (Th·ªß qu·ªπ) | Chi: Th·ªß qu·ªπ -->
                    <div class="sig-title" id="label-sig-3">Ng∆∞·ªùi nh·∫≠n ti·ªÅn</div>
                    <p class="sig-note">(K√Ω, h·ªç t√™n)</p>
                    <div class="sig-space"></div>
                    <div class="sig-name"></div>
                </div>

                <div class="sig-block">
                    <!-- Thu: Ng∆∞·ªùi n·ªôp ti·ªÅn | Chi: Ng∆∞·ªùi nh·∫≠n ti·ªÅn -->
                    <div class="sig-title" id="label-sig-4">Ng∆∞·ªùi n·ªôp ti·ªÅn</div>
                    <p class="sig-note">(K√Ω, h·ªç t√™n)</p>
                    <div class="sig-space"></div>
                    <div class="sig-name" id="ten-doi-tuong-ky"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // H√†m ƒë·ªçc s·ªë ti·ªÅn th√†nh ch·ªØ
        function readNumberInVietnamese(number) { 
            const units=["","m·ªôt","hai","ba","b·ªën","nƒÉm","s√°u","b·∫£y","t√°m","ch√≠n"];
            const groupUnits=[""," ngh√¨n"," tri·ªáu"," t·ª∑"," ngh√¨n t·ª∑"," tri·ªáu t·ª∑"];
            
            function convertBlock(e){
                if("000"===e)return"";
                let t=parseInt(e[0]),r=parseInt(e[1]),n=parseInt(e[2]),i="";
                return t>0&&(i+=units[t]+" trƒÉm"),0===r&&n>0?i+=t>0?" linh "+units[n]:units[n]:1===r?(i+=" m∆∞·ªùi",5===n?i+=" lƒÉm":n>0&&(i+=" "+units[n])):r>1&&(i+=" "+units[r]+" m∆∞∆°i",1===n?i+=" m·ªët":5===n?i+=" lƒÉm":n>0&&(i+=" "+units[n])),i.trim()
            }
            
            let numStr=String(parseInt(number,10));
            if("0"===numStr||isNaN(parseInt(number))) return "Kh√¥ng ƒë·ªìng";
            
            let chunks=[];
            for(;numStr.length>0;)chunks.unshift(numStr.slice(-3)),numStr=numStr.slice(0,-3);
            
            const result=chunks.map((e,t)=>{
                for(;e.length<3;)e="0"+e;
                const r=convertBlock(e);
                if(!r)return"";
                let n=groupUnits[chunks.length-1-t];
                return 0===parseInt(e)&&" ngh√¨n"===n?"":r+n
            }).filter(Boolean).join(" ");
            
            let final = (result.charAt(0).toUpperCase()+result.slice(1)).trim()+" ƒë·ªìng";
            return final.replace(/  /g, " "); 
        }

        function removeVietnameseTones(str) {
            if(!str) return "";
            return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/ƒë/g, 'd').replace(/ƒê/g, 'D');
        }

        function formatDate(dateStr) {
            // Ch·∫•p nh·∫≠n ƒë·ªãnh d·∫°ng dd/mm/yyyy ho·∫∑c yyyy-mm-dd
            if (!dateStr) return { day: '...', month: '...', year: '...' };
            
            let d;
            if (dateStr.includes('/')) {
                const parts = dateStr.split('/');
                // Gi·∫£ s·ª≠ input l√† dd/mm/yyyy
                return { day: parts[0], month: parts[1], year: parts[2] };
            } else if (dateStr.includes('-')) {
                d = new Date(dateStr);
            } else {
                d = new Date();
            }
            return {
                day: d.getDate().toString().padStart(2, '0'),
                month: (d.getMonth() + 1).toString().padStart(2, '0'),
                year: d.getFullYear()
            };
        }

        // H√†m t·∫°o QR Code
        function generateQRCode(text) {
            const container = document.getElementById('qr-code-box');
            if(!text) { container.innerHTML = ''; return; }
            const url = `https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${encodeURIComponent(text)}&format=svg`;
            container.innerHTML = `<img src="${url}" alt="QR">`;
        }

        // H√†m ch√≠nh ƒë·ªÉ ƒëi·ªÅn d·ªØ li·ªáu
        function populateData() {
            const urlParams = new URLSearchParams(window.location.search);
            
            // --- 1. Ch·∫ø ƒë·ªô DEMO (N·∫øu kh√¥ng c√≥ tham s·ªë URL) ---
            let data = {};
            if (!urlParams.has('so_tien')) {
                console.log("Running Demo Mode");
                data = {
                    hang_muc: 'Thu', // ho·∫∑c 'Chi'
                    so_tien: '6000000',
                    ngay_lap: '15/10/2025',
                    doi_tuong: 'Tr∆∞∆°ng Tu·∫•n Hi·ªáp - Ho√†ng Thu Ng·ªçc',
                    dia_chi: 'X√£ - Huy·ªán - T·ªânh', // B·∫£ng thu_chi kh√¥ng c√≥ ƒë·ªãa ch·ªâ, c√≥ th·ªÉ truy·ªÅn th√™m
                    noi_dung: 'THANH TO√ÅN L·∫¶N 2 (H·ª£p ƒë·ªìng HD250706...)',
                    hinh_thuc_tt: 'Chuy·ªÉn kho·∫£n',
                    tai_khoan_co: 'ACB-91926', // L·∫•y t·ª´ c·ªôt tai_khoan_co ho·∫∑c tai_khoan_no tu·ª≥ lo·∫°i
                    nguoi_tao: 'Nguy·ªÖn VƒÉn A',
                    ma_phieu: 'PT-251015-001',
                    giay_bao: 'Gi·∫•y b√°o c√≥'
                };
            } else {
                // --- 2. L·∫•y t·ª´ URL (Map t·ª´ b·∫£ng thu_chi) ---
                data = {
                    hang_muc: urlParams.get('hang_muc') || 'Thu',
                    so_tien: urlParams.get('so_tien') || '0',
                    ngay_lap: urlParams.get('ngay_lap'),
                    doi_tuong: urlParams.get('doi_tuong') || '',
                    dia_chi: urlParams.get('dia_chi') || '', // C√≥ th·ªÉ tr·ªëng
                    noi_dung: urlParams.get('noi_dung') || '',
                    hinh_thuc_tt: urlParams.get('hinh_thuc_tt') || '',
                    // N·∫øu l√† Thu -> L·∫•y t√†i kho·∫£n C√≥ (ti·ªÅn v√†o). N·∫øu l√† Chi -> L·∫•y t√†i kho·∫£n N·ª£ (ho·∫∑c TK ngu·ªìn)
                    tai_khoan: (urlParams.get('hang_muc') === 'Chi') ? urlParams.get('tai_khoan_no') : urlParams.get('tai_khoan_co'),
                    nguoi_tao: urlParams.get('nguoi_tao') || '',
                    ma_phieu: urlParams.get('id_thu_chi') || '',
                    giay_bao: urlParams.get('giay_bao') || ''
                };
            }

            // --- X·ª≠ l√Ω Logic hi·ªÉn th·ªã ---
            const isChi = data.hang_muc.toLowerCase() === 'chi';
            
            // 1. Ti√™u ƒë·ªÅ
            document.getElementById('voucher-header-text').textContent = isChi ? "PHI·∫æU CHI" : "PHI·∫æU THU";
            document.title = (isChi ? "Phieu_Chi_" : "Phieu_Thu_") + data.doi_tuong;

            // 2. Nh√£n (Labels)
            document.getElementById('label-doi-tuong').textContent = isChi ? "Ng∆∞·ªùi nh·∫≠n ti·ªÅn :" : "Ng∆∞·ªùi n·ªôp ti·ªÅn :";
            document.getElementById('label-sig-3').textContent = isChi ? "Th·ªß qu·ªπ" : "Ng∆∞·ªùi nh·∫≠n ti·ªÅn";
            document.getElementById('label-sig-4').textContent = isChi ? "Ng∆∞·ªùi nh·∫≠n ti·ªÅn" : "Ng∆∞·ªùi n·ªôp ti·ªÅn";

            // 3. D·ªØ li·ªáu ng√†y th√°ng
            const dateObj = formatDate(data.ngay_lap);
            document.getElementById('date-string').textContent = `Ng√†y ${dateObj.day} th√°ng ${dateObj.month} nƒÉm ${dateObj.year}`;

            // 4. C√°c tr∆∞·ªùng th√¥ng tin
            document.getElementById('doi-tuong').textContent = data.doi_tuong;
            document.getElementById('ten-doi-tuong-ky').textContent = data.doi_tuong; // ƒêi·ªÅn t√™n xu·ªëng ph·∫ßn k√Ω t√™n
            document.getElementById('dia-chi').textContent = data.dia_chi;
            document.getElementById('noi-dung').textContent = data.noi_dung;
            document.getElementById('hinh-thuc').textContent = data.hinh_thuc_tt;
            document.getElementById('nguoi-lap-phieu').textContent = data.nguoi_tao;
            document.getElementById('ma-phieu').textContent = data.ma_phieu;
            
            // T√†i kho·∫£n ng√¢n h√†ng (Ch·ªâ hi·ªán n·∫øu c√≥)
            const stkDisplay = data.tai_khoan ? data.tai_khoan : '';
            document.getElementById('so-tai-khoan').textContent = stkDisplay;

            // Gi·∫•y b√°o (n·∫øu c√≥)
            if(data.giay_bao) {
                document.getElementById('row-kem-theo').style.display = 'flex';
                document.getElementById('kem-theo').textContent = data.giay_bao;
            }

            // 5. S·ªë ti·ªÅn & Ch·ªØ
            // L√†m s·∫°ch chu·ªói s·ªë (b·ªè d·∫•u ph·∫©y n·∫øu c√≥ trong DB)
            const rawMoney = data.so_tien.toString().replace(/,/g, '').replace(/\./g, '');
            const moneyVal = parseInt(rawMoney, 10);
            
            document.getElementById('so-tien-so').textContent = moneyVal.toLocaleString('vi-VN');
            document.getElementById('so-tien-chu').textContent = readNumberInVietnamese(moneyVal);

            // 6. Generate QR
            // N·ªôi dung QR: M√£ phi·∫øu | S·ªë ti·ªÅn | ƒê·ªëi t∆∞·ª£ng
            const qrContent = `${data.ma_phieu}|${moneyVal}|${removeVietnameseTones(data.doi_tuong)}`;
            generateQRCode(qrContent);
            
            // 7. C·∫≠p nh·∫≠t th√¥ng tin Studio t·ª´ URL n·∫øu c√≥ (ghi ƒë√® m·∫∑c ƒë·ªãnh)
            if(urlParams.has('ten_studio')) document.getElementById('studio-name').textContent = urlParams.get('ten_studio');
            if(urlParams.has('diachi_studio')) document.getElementById('studio-address').textContent = urlParams.get('diachi_studio');
        }

        // Ch·ª©c nƒÉng t·∫£i PDF
        function downloadPDF() {
            const element = document.getElementById('voucher-content');
            const opt = {
                margin: 0,
                filename: document.title + '.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a5', orientation: 'landscape' } // A5 ngang
            };
            html2pdf().from(element).set(opt).save();
        }

        // Ch·ª©c nƒÉng t·∫£i ·∫¢nh
        function downloadImage() {
            const element = document.getElementById('voucher-content');
            html2canvas(element, { scale: 3, useCORS: true }).then(canvas => {
                const link = document.createElement('a');
                link.download = document.title + '.jpg';
                link.href = canvas.toDataURL('image/jpeg', 0.95);
                link.click();
            });
        }

        // Ch·∫°y khi load trang
        document.addEventListener('DOMContentLoaded', populateData);
    </script>
</body>
</html>
