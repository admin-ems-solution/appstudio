<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Há»£p Äá»“ng Cung Cáº¥p Dá»‹ch Vá»¥</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
   <style>
    @import url('https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;700&display=swap');
    :root {
        --page-width: 190mm; 
        --main-padding: 10pt;
        --dynamic-data-color: #0d6efd; 
    }
    body { font-family: 'Be Vietnam Pro', sans-serif; font-size: 9pt; line-height: 1.35; color: #212529; background-color: #f0f2f5; margin: 0; padding: 0; }
    
    .actions-container { 
        position: sticky; top: 0; display: flex; justify-content: flex-end; align-items: center;
        width: 100%; background-color: #343a40; padding: 8px 20px; box-sizing: border-box;
        z-index: 2000; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .actions-container .dropdown { position: relative; display: inline-block; margin-left: 10px; }
    .actions-container .dropdown-btn { background-color: #0d6efd; color: white; border: none; padding: 8px 16px; border-radius: 5px; font-size: 14px; font-weight: 500; cursor: pointer; }
    .actions-container .dropdown-btn.download-btn { background-color: #198754; }
    .actions-container .dropdown-content {
        display: none; position: absolute; right: 0; background-color: #f1f1f1; min-width: 200px;
        box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 1; border-radius: 5px;
    }
    .actions-container .dropdown-content a {
        color: black; padding: 12px 16px; text-decoration: none; display: block; font-size: 14px;
    }
    .actions-container .dropdown-content a:hover { background-color: #ddd; }
    .actions-container .dropdown-content.show { display: block; }

    .page-wrapper { display: flex; justify-content: center; padding: 20px 0; }
    .a4-page { 
        width: var(--page-width); 
        background-color: white; 
        margin: 0 auto; 
        box-shadow: 0 0 15px rgba(0,0,0,0.1);
        box-sizing: content-box;
    }
    #print-container { width: 100%; border-collapse: collapse; table-layout: fixed; }
    #page-header, #page-footer { height: 1px; }
    .header-content, .footer-content, .main-content { padding: var(--main-padding); box-sizing: border-box; }
    .main-content { padding-top: 0; padding-bottom: 0; }
    .footer-content { 
        padding-top: 10px; 
        text-align: right; 
        font-size: 9pt; 
        color: #6c757d; 
        border-top: 1px solid #dee2e6;
    }
    .dynamic-data { color: var(--dynamic-data-color); font-weight: 500; }

    .header-content { padding: 25px var(--main-padding); } 
    .header-content .header { display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #dee2e6; padding-bottom: 15px; }
    .header-left { display: flex; align-items: center; }
    .header-content .logo { width: 65px; height: 65px; flex-shrink: 0; }
    #contract-qr-container { width: 65px; height: 65px; flex-shrink: 0; }
    #contract-qr-container img { width: 100%; height: 100%; display: block; }
    .studio-info { padding-left: 15px !important; }
    .studio-info h2 { font-size: 12pt; margin: 0; }
    .studio-info p { font-size: 8.5pt; line-height: 1.3; margin: 0; }

    .main-title { text-align: center; font-size: 18pt; font-weight: 700; margin: 10px 0 5px 0; text-transform: uppercase; }
    .contract-meta { text-align: center; font-style: italic; color: #555; margin-bottom: 15px; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 9pt; }
    th, td { border: 1px solid #dee2e6; padding: 6px 8px; text-align: left; vertical-align: top; word-break: break-word; }
    th { background-color: #e9ecef; font-weight: 700; text-align: center; }
    
    .price-cell {
        white-space: nowrap;
        text-align: right !important;
    }

    .summary-and-payment { display: flex; justify-content: space-between; align-items: stretch; margin-top: 5px; margin-bottom: 20px; page-break-inside: avoid; }
    .qr-payment-section { width: 58%; border: 1px solid #e9ecef; padding: 15px; border-radius: 5px; box-sizing: border-box;}
    .qr-payment-content { display: flex; align-items: center; text-align: left; height: 100%;}
    .qr-code { width: 140px; height: 140px; flex-shrink: 0; margin-right: 15px; display: flex; justify-content: center; align-items: center; }
    .qr-code img { max-width: 100%; height: auto; border: 1px solid #ccc; display: block; }
    .payment-instructions p { margin: 4px 0; font-size: 9pt; }
    
    .summary-section { width: 40%; border: 1px solid #e9ecef; padding: 15px; border-radius: 5px; box-sizing: border-box; }
    .summary-section .summary-table { margin-bottom: 0; }
    .summary-table td { padding: 4px 8px; }
    .summary-table .highlight-red { color: #dc3545; font-weight: 700; }
    
    .terms-section { margin-top: 15px; border-top: 1px solid #dee2e6; padding-top: 10px; }
    .print-block { page-break-inside: avoid; margin-top: 15px; }
    .print-block h3 { font-size: 11pt; font-weight: 700; margin: 0 0 5px 0; }
    .print-block p, .print-block li { 
        margin-bottom: 4px;
        text-align: justify;
    }
    .print-block ul { padding-left: 20px; list-style-type: none; margin-block-start: 0; margin-block-end: 0; }
    .print-block ul li::before { content: "- "; }
    .signature-block { display: flex; justify-content: space-around; text-align: center; margin-top: 40px; padding-top: 15px; border-top: 1px solid #dee2e6; page-break-before: auto; }
    .signature-block p {
        text-align: center;
    }
    .signature-block .name { margin-top: 60px; font-weight: 700; }

    @media print {
        body { background: none; }
        .actions-container { display: none !important; }
        .page-wrapper { padding: 0; }
        .a4-page {
            box-shadow: none;
            border: none;
            margin: 0;
            width: 100%;
        }
        @page { 
            size: A4;
            margin: 10mm;
        }
        #print-container { display: table; width: 100%; }
        #page-header { display: table-row-group; }
        #page-footer { display: table-footer-group; }
    }
</style>
</head>
<body>
    <div class="actions-container">
        <div class="dropdown">
            <button id="print-dropdown-btn" class="dropdown-btn">ğŸ–¨ï¸ In Há»£p Äá»“ng â–¾</button>
            <div id="print-dropdown-content" class="dropdown-content">
                <a href="#" id="print-service-action">Há»£p Ä‘á»“ng Dá»‹ch vá»¥</a>
                <a href="#" id="print-dress-action">Há»£p Ä‘á»“ng VÃ¡y</a>
                <a href="#" id="print-family-action">Há»£p Ä‘á»“ng Baby & GÄ</a>
            </div>
        </div>
        <div class="dropdown">
            <button id="download-dropdown-btn" class="dropdown-btn download-btn">ğŸ“„ Táº£i vá» PDF â–¾</button>
            <div id="download-dropdown-content" class="dropdown-content">
                <a href="#" id="download-service-action">Há»£p Ä‘á»“ng Dá»‹ch vá»¥</a>
                <a href="#" id="download-dress-action">Há»£p Ä‘á»“ng VÃ¡y</a>
                <a href="#" id="download-family-action">Há»£p Ä‘á»“ng Baby & GÄ</a>
            </div>
        </div>
    </div>
    <div class="page-wrapper">
        <div class="a4-page" id="a4-page-content">
            <table id="print-container">
                <thead id="page-header"><tr><td><div class="header-content"></div></td></tr></thead>
                <tbody><tr><td><div class="main-content"></div></td></tr></tbody>
                <tfoot id="page-footer"><tr><td><div class="footer-content"><span class="page-number"></span></div></td></tr></tfoot>
            </table>
        </div>
    </div>
    
    <script>
        // === START: KHAI BÃO BIáº¾N TOÃ€N Cá»¤C Äá»‚ LÆ¯U Dá»® LIá»†U JSON ===
        let globalServiceData = []; 
        // === END ===

        const CONTRACT_TERMS_SERVICE = `
            <div class="print-block">
                <h3>HÃ¬nh thá»©c thanh toÃ¡n:</h3>
                <ul><li>Láº§n 1 : 20% ( Ä‘áº·t cá»c )</li><li>Láº§n 2 : 70% (cuá»‘i buá»•i chá»¥p hÃ¬nh)</li><li>Láº§n 3 : 10% ( khi nháº­n áº£nh in )</li></ul>
                <p><strong>PhÆ°Æ¡ng thá»©c thanh toÃ¡n:</strong> Chuyá»ƒn khoáº£n hoáº·c Tiá»n máº·t</p>
                <p><strong>Hai bÃªn thá»‘ng nháº¥t kÃ½ há»£p Ä‘á»“ng vá»›i nhá»¯ng Ä‘iá»u khoáº£n nhÆ° sau:</strong></p>
            </div>
            <div class="print-block">
                <h3>Äiá»u 1: TrÃ¡ch nhiá»‡m vÃ  quyá»n lá»£i cá»§a cÃ¡c BÃªn</h3>
                <p><strong>1.1. TrÃ¡ch nhiá»‡m vÃ  quyá»n lá»£i cá»§a bÃªn A:</strong></p>
                <ul><li>BÃªn A cÃ³ trÃ¡ch nhiá»‡m thanh toÃ¡n cho BÃªn B phÃ­ dá»‹ch vá»¥ Ä‘Ãºng háº¡n theo hÃ¬nh thá»©c thanh toÃ¡n nÃªu trÃªn.</li><li>BÃªn A Ä‘Æ°á»£c nháº­n toÃ n bá»™ sáº£n pháº©m theo pháº§n chi tiáº¿t cá»§a há»£p Ä‘á»“ng nÃ y.</li><li>TrÆ°á»ng há»£p bÃªn A há»§y há»£p Ä‘á»“ng sáº½ máº¥t toÃ n bá»™ tiá»n Ä‘áº·t cá»c.</li><li>BÃªn A Ä‘Æ°á»£c quyá»n hoÃ£n chá»¥p hÃ¬nh (quay video) 01 láº§n mÃ  khÃ´ng bá»‹ tÃ­nh phÃ­ nhÆ°ng pháº£i bÃ¡o trÆ°á»›c cho bÃªn B muá»™n nháº¥t 3 ngÃ y trÆ°á»›c ngÃ y chá»¥p.</li><li>Náº¿u bÃªn A tiáº¿p tá»¥c phÃ¡t sinh viá»‡c hoÃ£n lá»‹ch thÃ¬ sáº½ chá»‹u chi phÃ­ phÃ¡t sinh: 1.000.000 VND/láº§n.</li><li>BÃªn A Ä‘Æ°á»£c quyá»n hoÃ£n chá»¥p hÃ¬nh 01 láº§n vÃ o ngÃ y chá»¥p trong trÆ°á»ng há»£p khÃ¡ch quan thá»i tiáº¿t xáº¥u, tuy nhiÃªn BÃªn A pháº£i thanh toÃ¡n cÃ¡c chi phÃ­ cá»‘ Ä‘á»‹nh Ä‘Ã£ phÃ¡t sinh trong ngÃ y nÃ y - VD: Hoa tay, thuÃª xe, trang Ä‘iá»ƒm.</li><li>BÃªn A tá»± chá»‹u trÃ¡ch nhiá»‡m vá» an toÃ n cÃ¡ nhÃ¢n trong quÃ¡ trÃ¬nh chá»¥p áº£nh, quay phim.</li><li>TrÆ°á»ng há»£p bÃªn A há»§y há»£p Ä‘á»“ng sau khi chá»¥p Ä‘Ã£ copy toÃ n bá»™ file gá»‘c sáº½ khÃ´ng nháº­n láº¡i Ä‘Æ°á»£c tiá»n thanh toÃ¡n 2 láº§n Ä‘áº·t cá»c.</li><li>TrÆ°á»ng há»£p bÃªn A muá»‘n copy file Raw, sáº½ thanh toÃ¡n háº¿t phÃ­ dá»‹ch vá»¥.</li></ul>
                <p><strong>1.2. TrÃ¡ch nhiá»‡m vÃ  quyá»n lá»£i cá»§a BÃªn B:</strong></p>
                <ul><li>BÃªn B cÃ³ trÃ¡ch nhiá»‡m thá»±c hiá»‡n Ä‘áº§y Ä‘á»§ cÃ¡c ná»™i dung nghiá»‡p vá»¥ tÆ°Æ¡ng á»©ng vá»›i cÃ¡c dá»‹ch vá»¥ kÃ½ káº¿t, Ä‘Æ°á»£c niÃªm yáº¿t cÃ´ng khai kÃ¨m theo bÃ¡o giÃ¡.</li><li>BÃªn B Ä‘áº£m báº£o thá»±c hiá»‡n há»£p Ä‘á»“ng nÃ y vá»›i cháº¥t lÆ°á»£ng cao vÃ  nhiá»‡t tÃ¬nh vá»›i cÃ´ng viá»‡c, Ä‘Ãºng nguyÃªn táº¯c minh báº¡ch, trung thá»±c, uy tÃ­n, khÃ¡ch quan vÃ  bÃ­ máº­t vá» thÃ´ng tin cÃ¡ nhÃ¢n cá»§a khÃ¡ch hÃ ng.</li></ul>
            </div>
            <div class="print-block">
                <h3>Äiá»u 2: Cam káº¿t thá»±c hiá»‡n</h3>
                <ul><li>Hai bÃªn cam káº¿t thá»±c hiá»‡n táº¥t cáº£ cÃ¡c Ä‘iá»u khoáº£n Ä‘Ã£ ghi trong há»£p Ä‘á»“ng.</li><li>Trong quÃ¡ trÃ¬nh thá»±c hiá»‡n náº¿u gáº·p khÃ³ khÄƒn hai BÃªn pháº£i ká»‹p thá»i thÃ´ng bÃ¡o cho nhau, cáº§n thiáº¿t thÃ¬ trao Ä‘á»•i báº±ng vÄƒn báº£n tÃ¬m giáº£i phÃ¡p thÃ­ch há»£p.</li></ul>
                <p>Há»£p Ä‘á»“ng nÃ y Ä‘Æ°á»£c láº­p thÃ nh 02 báº£n cÃ³ giÃ¡ trá»‹ nhÆ° nhau, BÃªn A giá»¯ 01 báº£n, BÃªn B giá»¯ 01 báº£n vÃ  cÃ³ hiá»‡u lá»±c ká»ƒ tá»« ngÃ y kÃ½ há»£p Ä‘á»“ng, cho Ä‘áº¿n khi bÃªn B hoÃ n thÃ nh cÃ¡c dá»‹ch vá»¥ quy Ä‘á»‹nh táº¡i Äiá»u 1 vÃ  BÃªn A thanh toÃ¡n xong phÃ­ dá»‹ch vá»¥ cho BÃªn B thÃ¬ há»£p Ä‘á»“ng nÃ y xem nhÆ° Ä‘Æ°á»£c thanh lÃ½ hoáº·c cáº£ hai bÃªn cÃ¹ng thá»‘ng nháº¥t cháº¥m dá»©t há»£p Ä‘á»“ng báº±ng vÄƒn báº£n.</p>
                <ul><li>CÃ¡c Ä‘iá»u khoáº£n dá»‹ch vá»¥ Ä‘Æ°á»£c sá»­ dá»¥ng trong vÃ²ng 1 nÄƒm tÃ­nh tá»« ngÃ y kÃ½ há»£p Ä‘á»“ng.</li></ul>
            </div>
            <div class="signature-block print-block">
                <div class="customer-signature"><p style="font-weight: 700;">KhÃ¡ch hÃ ng</p><p style="font-size: 9pt; color: #6c757d; font-style: italic;">(KÃ½ vÃ  ghi há» tÃªn)</p><p class="name" id="customer-signature-name" class="dynamic-data"></p></div><div class="staff-signature"><p style="font-weight: 700;">NhÃ¢n viÃªn tÆ° váº¥n</p><p style="font-size: 9pt; color: #6c757d; font-style: italic;">(KÃ½ vÃ  ghi há» tÃªn)</p><p class="name" id="staff-signature-name" class="dynamic-data"></p></div><div class="studio-signature"><p style="font-weight: 700;" id="studio-signature-name-top"></p><p style="font-size: 9pt; color: #6c757d; font-style: italic;">(KÃ½ vÃ  ghi há» tÃªn)</p><p class="name" id="studio-signature-name-bottom"></p></div>
            </div>`;
            
        const CONTRACT_TERMS_DRESS = `
            <div class="print-block">
                <p><strong>Hai bÃªn thá»‘ng nháº¥t kÃ½ há»£p Ä‘á»“ng vá»›i nhá»¯ng Ä‘iá»u khoáº£n nhÆ° sau:</strong></p>
                <h3>Äiá»u 1: Ná»™i dung dá»‹ch vá»¥</h3>
                <p>BÃªn B Ä‘á»“ng Ã½ cung cáº¥p cho BÃªn A cÃ¡c dá»‹ch vá»¥ nhÆ° báº£ng trÃªn :</p>
                <p><strong>Hiá»‡n tráº¡ng vÃ¡y:</strong> ...............................................................................................................................</p>
                <p><strong>Phá»¥ kiá»‡n nháº­n Ä‘Æ°á»£c:</strong> ....................................................................................................................</p>
                <h3>Äiá»u 2: PhÃ­ dá»‹ch vá»¥ vÃ  phÆ°Æ¡ng thá»©c thanh toÃ¡n</h3>
                <p><strong>HÃ¬nh thá»©c cá»c lÃ m tin:</strong></p>
                <p style="padding-left: 20px;">â˜ Äáº·t cá»c cÄƒn cÆ°á»›c, giáº¥y tá» xe</p>
                <p style="padding-left: 20px;">â˜ Äáº·t cá»c tiá»n máº·t</p>
                <p><strong>HÃ¬nh thá»©c thanh toÃ¡n:</strong></p>
                <p style="padding-left: 20px;">2H STUDIO - HOÃ€NG Cáº¦U: ACB - 33070607 - NGUYá»„N THá»Š ANH</p>
                <h3>Äiá»u 3: TrÃ¡ch nhiá»‡m vÃ  quyá»n lá»£i cá»§a cÃ¡c BÃªn</h3>
                <p><strong>1. TrÃ¡ch nhiá»‡m vÃ  quyá»n lá»£i cá»§a bÃªn A.</strong></p>
                <ul><li>BÃªn A cÃ³ trÃ¡ch nhiá»‡m thanh toÃ¡n cho BÃªn B phÃ­ dá»‹ch vá»¥ theo Äiá»u 1-2 Ä‘Ãºng háº¡n.</li><li>TrÆ°á»ng há»£p bÃªn A há»§y há»£p Ä‘á»“ng vÃ¡y sáº½ khÃ´ng Ä‘Æ°á»£c hoÃ n láº¡i phÃ­ thanh toÃ¡n.</li><li>BÃªn A Ä‘Æ°á»£c nháº­n toÃ n bá»™ sáº£n pháº©m theo pháº§n chi tiáº¿t cá»§a há»£p Ä‘á»“ng nÃ y.</li><li>TrÆ°á»ng há»£p bÃªn A lÃ m vÃ¡y bá»‹ dÃ­nh rÆ°á»£u vang, pháº©m mÃ u nhiá»u trÃªn 1 bÃ n tay sáº½ kháº¥u hao 500-800k tÃ¹y theo cháº¥t liá»‡u vÃ¡y.</li><li>TrÆ°á»ng há»£p bÃªn A lÃ m máº¥t hoáº·c hÆ° háº¡i hoÃ n toÃ n vÃ¡y sáº½ Ä‘á»n toÃ n bá»™ phÃ­ cá»c lÃ m tin.</li><li>TrÆ°á»ng há»£p bÃªn A lÃ m hÆ° há»ng vÃ¡y, bá»‹ dÃ­nh cháº¥t pháº©m khÃ´ng giáº·t Ä‘Æ°á»£c, vÃ¡y bá»‹ quÃ¡ báº©n, hiá»‡n tráº¡ng vÃ¡y khÃ´ng Ä‘Æ°á»£c nhÆ° cam káº¿t á»Ÿ Ä‘iá»u 1:<ul style="padding-left: 20px; list-style-type: circle;"><li>Studio giá»¯ láº¡i vÃ¡y vÃ  cá»c vÃ¡y (chá» xá»­ lÃ½ 4-5 ngÃ y), xá»­ lÃ½ Ä‘Æ°á»£c sáº½ hoÃ n láº¡i phÃ­ cá»c cho dÃ¢u rá»ƒ.</li><li>TrÆ°á»ng há»£p vÃ¡y khÃ´ng xá»­ lÃ½ Ä‘Æ°á»£c studio buá»™c pháº£i trá»« kháº¥u hao vÃ o phÃ­ cá»c vÃ¡y (30% - 80% phÃ­ cá»c vÃ¡y).</li></ul></li><li>TrÆ°á»ng há»£p bÃªn A khÃ´ng tráº£ Ä‘á»“ Ä‘Ãºng ngÃ y trong há»£p Ä‘á»“ng, chi phÃ­ phÃ¡t sinh lÃ  500k/ 1 ngÃ y.</li><li>TrÆ°á»ng há»£p bÃªn A tá»± Ã½ sá»­a Ä‘á»“ khi chÆ°a cÃ³ sá»± Ä‘á»“ng Ã½ cá»§a bÃªn B, thÃ¬ sáº½ Ä‘á»n giÃ¡ trá»‹ tÆ°Æ¡ng á»©ng vá»›i Ä‘á»“ Ä‘Ã£ sá»­a.</li><li>Khi tráº£ vÃ¡y kÃ¨m theo há»£p Ä‘á»“ng láº¥y vÃ¡y.</li></ul>
                <p><strong>2. TrÃ¡ch nhiá»‡m vÃ  quyá»n lá»£i cá»§a BÃªn B.</strong></p>
                <ul><li>BÃªn B cÃ³ trÃ¡ch nhiá»‡m thá»±c hiá»‡n Ä‘áº§y Ä‘á»§ cÃ¡c ná»™i dung nghiá»‡p vá»¥ tÆ°Æ¡ng á»©ng vá»›i cÃ¡c dá»‹ch vá»¥ kÃ½ káº¿t, Ä‘Æ°á»£c niÃªm yáº¿t cÃ´ng khai kÃ¨m theo bÃ¡o giÃ¡, sau khi nháº­n Ä‘Æ°á»£c hiá»‡n tráº¡ng vÃ¡y theo Ä‘Ãºng quy Ä‘á»‹nh tiÃªu chuáº©n nhÆ° Ä‘iá»u 1 sáº½ hoÃ n láº¡i phÃ­ Ä‘áº·t cá»c cho bÃªn A.</li><li>BÃªn B Ä‘áº£m báº£o thá»±c hiá»‡n há»£p Ä‘á»“ng nÃ y vá»›i cháº¥t lÆ°á»£ng cao vÃ  nhiá»‡t tÃ¬nh vá»›i cÃ´ng viá»‡c, Ä‘Ãºng nguyÃªn táº¯c minh báº¡ch, trung thá»±c, uy tÃ­n, khÃ¡ch quan vÃ  bÃ­ máº­t vá» thÃ´ng tin cÃ¡ nhÃ¢n cá»§a khÃ¡ch hÃ ng.</li></ul>
            </div>
            <div class="print-block">
                <h3>Cam káº¿t thá»±c hiá»‡n</h3>
                <ul><li>Hai bÃªn cam káº¿t thá»±c hiá»‡n táº¥t cáº£ cÃ¡c Ä‘iá»u khoáº£n Ä‘Ã£ ghi trong há»£p Ä‘á»“ng.</li><li>Trong quÃ¡ trÃ¬nh thá»±c hiá»‡n náº¿u gáº·p khÃ³ khÄƒn hai BÃªn pháº£i ká»‹p thá»i thÃ´ng bÃ¡o cho nhau, cáº§n thiáº¿t thÃ¬ trao Ä‘á»•i báº±ng vÄƒn báº£n tÃ¬m giáº£i phÃ¡p thÃ­ch há»£p.</li></ul>
                <p>Há»£p Ä‘á»“ng nÃ y Ä‘Æ°á»£c láº­p thÃ nh 02 báº£n cÃ³ giÃ¡ trá»‹ nhÆ° nhau, BÃªn A giá»¯ 01 báº£n, BÃªn B giá»¯ 01 báº£n vÃ  cÃ³ hiá»‡u lá»±c ká»ƒ tá»« ngÃ y kÃ½ há»£p Ä‘á»“ng, cho Ä‘áº¿n khi bÃªn B hoÃ n thÃ nh cÃ¡c dá»‹ch vá»¥ quy Ä‘á»‹nh táº¡i Äiá»u 1 vÃ  BÃªn A thanh toÃ¡n xong phÃ­ dá»‹ch vá»¥ cho BÃªn B thÃ¬ há»£p Ä‘á»“ng nÃ y xem nhÆ° Ä‘Æ°á»£c thanh lÃ½ hoáº·c cáº£ hai bÃªn cÃ¹ng thá»‘ng nháº¥t cháº¥m dá»©t há»£p Ä‘á»“ng báº±ng vÄƒn báº£n.</p>
            </div>
            <div class="signature-block print-block">
                <div class="customer-signature"><p style="font-weight: 700;">KhÃ¡ch hÃ ng</p><p style="font-size: 9pt; color: #6c757d; font-style: italic;">(KÃ½ vÃ  ghi há» tÃªn)</p><p class="name" id="customer-signature-name" class="dynamic-data"></p></div><div class="staff-signature"><p style="font-weight: 700;">NhÃ¢n viÃªn tÆ° váº¥n</p><p style="font-size: 9pt; color: #6c757d; font-style: italic;">(KÃ½ vÃ  ghi há» tÃªn)</p><p class="name" id="staff-signature-name" class="dynamic-data"></p></div><div class="studio-signature"><p style="font-weight: 700;" id="studio-signature-name-top"></p><p style="font-size: 9pt; color: #6c757d; font-style: italic;">(KÃ½ vÃ  ghi há» tÃªn)</p><p class="name" id="studio-signature-name-bottom"></p></div>
            </div>`;
        
        const CONTRACT_TERMS_FAMILY = `
            <div class="print-block">
                <h3>HÃ¬nh Thá»©c Thanh ToÃ¡n</h3>
                <ul><li>Láº§n 1: 50% (Ä‘áº·t cá»c)</li><li>Láº§n 2: 50% (cuá»‘i buá»•i chá»¥p)</li></ul>
                <h3>Äiá»u Khoáº£n Há»£p Äá»“ng</h3>
                <p><strong>Hai bÃªn thá»‘ng nháº¥t kÃ½ há»£p Ä‘á»“ng vá»›i nhá»¯ng Ä‘iá»u khoáº£n nhÆ° sau:</strong></p>
                <ul><li>BÃªn A cÃ³ trÃ¡ch nhiá»‡m thanh toÃ¡n cho bÃªn B phÃ­ dá»‹ch vá»¥ Ä‘Ãºng háº¡n theo hÃ¬nh thá»©c thanh toÃ¡n nÃªu trÃªn.</li><li>BÃªn A chá»‹u rá»§i ro sáº£n pháº©m theo chi tiáº¿t cá»§a há»£p Ä‘á»“ng.</li><li>TrÆ°á»ng há»£p bÃªn A huá»· há»£p Ä‘á»“ng sáº½ máº¥t toÃ n bá»™ phÃ­ cá»c.</li><li>BÃªn A Ä‘Æ°á»£c quyá»n chá»n chá»¥p hÃ¬nh 1 láº§n mÃ  khÃ´ng bá»‹ tÃ­nh phÃ­ nhÆ°ng pháº£i bÃ¡o trÆ°á»›c ngÃ y chá»¥p 5 ngÃ y.</li><li>BÃªn B Ä‘áº£m báº£o thá»±c hiá»‡n há»£p Ä‘á»“ng nÃ y vá»›i cháº¥t lÆ°á»£ng cao vÃ  nhiá»‡t tÃ¬nh, vá»›i cÃ´ng viá»‡c, trung thá»±c, uy tÃ­n, khÃ¡ch quan vÃ  báº£o máº­t vá» thÃ´ng tin cá»§a khÃ¡ch hÃ ng.</li></ul>
                <p><strong>LÆ°u Ã½:</strong> GÃ³i chá»¥p chá»‰ Ã¡p dá»¥ng cho cÃ¡c trang phá»¥c vÃ  concept cÃ³ sáºµn táº¡i studio, cÃ¡c concept khÃ¡c theo sá»Ÿ thÃ­ch setup thÃªm cá»§a khÃ¡ch sáº½ tá»± thuÃª hoáº·c studio thuÃª há»™ vÃ  tráº£ phÃ­.</p>
            </div>
            <div class="print-block">
                <h3>Cam káº¿t thá»±c hiá»‡n</h3>
                <ul><li>Hai bÃªn cam káº¿t thá»±c hiá»‡n táº¥t cáº£ cÃ¡c Ä‘iá»u khoáº£n Ä‘Ã£ ghi trong há»£p Ä‘á»“ng.</li><li>Trong quÃ¡ trÃ¬nh thá»±c hiá»‡n náº¿u gáº·p khÃ³ khÄƒn hai BÃªn pháº£i ká»‹p thá»i thÃ´ng bÃ¡o cho nhau, cáº§n thiáº¿t thÃ¬ trao Ä‘á»•i báº±ng vÄƒn báº£n tÃ¬m giáº£i phÃ¡p thÃ­ch há»£p.</li></ul>
                <p>Há»£p Ä‘á»“ng nÃ y Ä‘Æ°á»£c láº­p thÃ nh 02 báº£n cÃ³ giÃ¡ trá»‹ nhÆ° nhau, BÃªn A giá»¯ 01 báº£n, BÃªn B giá»¯ 01 báº£n vÃ  cÃ³ hiá»‡u lá»±c ká»ƒ tá»« ngÃ y kÃ½ há»£p Ä‘á»“ng, cho Ä‘áº¿n khi bÃªn B hoÃ n thÃ nh cÃ¡c dá»‹ch vá»¥ quy Ä‘á»‹nh táº¡i Äiá»u 1 vÃ  BÃªn A thanh toÃ¡n xong phÃ­ dá»‹ch vá»¥ cho BÃªn B thÃ¬ há»£p Ä‘á»“ng nÃ y xem nhÆ° Ä‘Æ°á»£c thanh lÃ½ hoáº·c cáº£ hai bÃªn cÃ¹ng thá»‘ng nháº¥t cháº¥m dá»©t há»£p Ä‘á»“ng báº±ng vÄƒn báº£n.</p>
                <ul><li>CÃ¡c Ä‘iá»u khoáº£n dá»‹ch vá»¥ Ä‘Æ°á»£c sá»­ dá»¥ng trong vÃ²ng 1 nÄƒm tÃ­nh tá»« ngÃ y kÃ½ há»£p Ä‘á»“ng.</li></ul>
            </div>
             <div class="signature-block print-block">
                <div class="customer-signature"><p style="font-weight: 700;">KhÃ¡ch hÃ ng</p><p style="font-size: 9pt; color: #6c757d; font-style: italic;">(KÃ½ vÃ  ghi há» tÃªn)</p><p class="name" id="customer-signature-name" class="dynamic-data"></p></div><div class="staff-signature"><p style="font-weight: 700;">NhÃ¢n viÃªn tÆ° váº¥n</p><p style="font-size: 9pt; color: #6c757d; font-style: italic;">(KÃ½ vÃ  ghi há» tÃªn)</p><p class="name" id="staff-signature-name" class="dynamic-data"></p></div><div class="studio-signature"><p style="font-weight: 700;" id="studio-signature-name-top"></p><p style="font-size: 9pt; color: #6c757d; font-style: italic;">(KÃ½ vÃ  ghi há» tÃªn)</p><p class="name" id="studio-signature-name-bottom"></p></div>
            </div>`;

        function removeVietnameseTones(str) {if(!str)return"";str=str.replace(/Ã |Ã¡|áº¡|áº£|Ã£|Ã¢|áº§|áº¥|áº­|áº©|áº«|Äƒ|áº±|áº¯|áº·|áº³|áºµ/g,"a");str=str.replace(/Ã¨|Ã©|áº¹|áº»|áº½|Ãª|á»|áº¿|á»‡|á»ƒ|á»…/g,"e");str=str.replace(/Ã¬|Ã­|á»‹|á»‰|Ä©/g,"i");str=str.replace(/Ã²|Ã³|á»|á»|Ãµ|Ã´|á»“|á»‘|á»™|á»•|á»—|Æ¡|á»|á»›|á»£|á»Ÿ|á»¡/g,"o");str=str.replace(/Ã¹|Ãº|á»¥|á»§|Å©|Æ°|á»«|á»©|á»±|á»­|á»¯/g,"u");str=str.replace(/á»³|Ã½|á»µ|á»·|á»¹/g,"y");str=str.replace(/Ä‘/g,"d");str=str.replace(/Ã€|Ã|áº |áº¢|Ãƒ|Ã‚|áº¦|áº¤|áº¬|áº¨|áºª|Ä‚|áº°|áº®|áº¶|áº²|áº´/g,"A");str=str.replace(/Ãˆ|Ã‰|áº¸|áºº|áº¼|ÃŠ|á»€|áº¾|á»†|á»‚|á»„/g,"E");str=str.replace(/ÃŒ|Ã|á»Š|á»ˆ|Ä¨/g,"I");str=str.replace(/Ã’|Ã“|á»Œ|á»|Ã•|Ã”|á»’|á»|á»˜|á»”|á»–|Æ |á»œ|á»š|á»¢|á»|á» /g,"O");str=str.replace(/Ã™|Ãš|á»¤|á»¦|Å¨|Æ¯|á»ª|á»¨|á»°|á»¬|á»®/g,"U");str=str.replace(/á»²|Ã|á»´|á»¶|á»¸/g,"Y");str=str.replace(/Ä/g,"D");str=str.replace(/\u0300|\u0301|\u0303|\u0309|\u0323/g,"");str=str.replace(/\u02C6|\u0306|\u031B/g,"");return str.trim()}
        function readNumberInVietnamese(number) { const units=["","má»™t","hai","ba","bá»‘n","nÄƒm","sÃ¡u","báº£y","tÃ¡m","chÃ­n"],groupUnits=[""," nghÃ¬n"," triá»‡u"," tá»·"," nghÃ¬n tá»·"," triá»‡u tá»·"];function convertBlock(e){if("000"===e)return"";let t=parseInt(e[0]),r=parseInt(e[1]),n=parseInt(e[2]),i="";return t>0&&(i+=units[t]+" trÄƒm"),0===r&&n>0?i+=t>0?" linh "+units[n]:units[n]:1===r?(i+=" mÆ°á»i",5===n?i+=" lÄƒm":n>0&&(i+=" "+units[n])):r>1&&(i+=" "+units[r]+" mÆ°Æ¡i",1===n?i+=" má»‘t":5===n?i+=" lÄƒm":n>0&&(i+=" "+units[n])),i.trim()}let numStr=String(parseInt(number,10));if("0"===numStr)return"KhÃ´ng Ä‘á»“ng";let chunks=[];for(;numStr.length>0;)chunks.unshift(numStr.slice(-3)),numStr=numStr.slice(0,-3);const result=chunks.map((e,t)=>{for(;e.length<3;)e="0"+e;const r=convertBlock(e);if(!r)return"";let n=groupUnits[chunks.length-1-t];return 0===parseInt(e)&&" nghÃ¬n"===n?"":r+n}).filter(Boolean).join(" ");return(result.charAt(0).toUpperCase()+result.slice(1)).trim()+" Ä‘á»“ng"}
        const BANK_MAP={"970422":"MBBank","970436":"Vietcombank","970415":"Vietinbank","970403":"BIDV","970418":"Techcombank","970448":"OCB","970405":"AgriBank","970432":"VPBank","970423":"TPBank"};
        
        document.addEventListener('DOMContentLoaded', function(){
            injectHTMLStructure();
            renderContractTerms('service'); 

            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('ma_hd') && urlParams.get('ma_hd').trim() !== '') {
                populateFromUrl(urlParams);
            } else {
                runDemoMode();
            }
            
            function setupDropdowns() {
                const dropdownBtns = document.querySelectorAll('.dropdown-btn');
                
                dropdownBtns.forEach(btn => {
                    btn.addEventListener('click', function(event) {
                        event.stopPropagation();
                        closeAllDropdowns(this.nextElementSibling);
                        this.nextElementSibling.classList.toggle('show');
                    });
                });
                
                document.getElementById('print-service-action').addEventListener('click', (e) => { e.preventDefault(); renderContractTerms('service'); setTimeout(() => window.print(), 100); });
                document.getElementById('print-dress-action').addEventListener('click', (e) => { e.preventDefault(); renderContractTerms('dress'); setTimeout(() => window.print(), 100); });
                document.getElementById('print-family-action').addEventListener('click', (e) => { e.preventDefault(); renderContractTerms('family'); setTimeout(() => window.print(), 100); });

                document.getElementById('download-service-action').addEventListener('click', (e) => { e.preventDefault(); downloadAsPdf('service', 'HD_Dich_Vu'); });
                document.getElementById('download-dress-action').addEventListener('click', (e) => { e.preventDefault(); downloadAsPdf('dress', 'HD_Vay'); });
                document.getElementById('download-family-action').addEventListener('click', (e) => { e.preventDefault(); downloadAsPdf('family', 'HD_Baby_GD'); });
            }

            function closeAllDropdowns(exceptThisOne = null) {
                const dropdowns = document.querySelectorAll('.dropdown-content');
                dropdowns.forEach(dropdown => {
                    if (dropdown !== exceptThisOne && dropdown.classList.contains('show')) {
                        dropdown.classList.remove('show');
                    }
                });
            }

            window.onclick = function(event) {
                if (!event.target.matches('.dropdown-btn')) {
                    closeAllDropdowns();
                }
            }
            
            setupDropdowns();

            function populateFromUrl(params) {
                 const paramToIdMap = { 
                     ten_studio: ['studio-name', 'studio-signature-name-top', 'studio-signature-name-bottom'],
                     ten_chi_nhanh: 'branch-name-main',
                     diachi_studio: 'studio-address',
                     website_studio: 'studio-website',
                     email_studio: 'studio-email',
                     dienthoai_studio: 'studio-phone',
                     zalo_studio: 'studio-zalo',
                     ma_hd: 'contract-id', 
                     ngay_hd: 'contract-date', 
                     khach_hang: 'customer-name', 
                     dien_thoai_kh: 'customer-phone', 
                     dia_chi_kh: 'customer-address', 
                     nhan_vien: 'staff-name', 
                     dien_thoai_nv: 'staff-phone', 
                     chuc_vu_nv: 'staff-title', 
                     thanh_tien: 'subtotal', 
                     tong_phat_sinh: 'additional-cost', 
                     khuyen_mai_tong: 'total-promotion',
                     phai_thanh_toan: 'total-due', 
                     da_thanh_toan: 'amount-paid', 
                     con_lai: 'amount-remaining', 
                     ten_ky_kh: 'customer-signature-name', 
                     ten_ky_nv: 'staff-signature-name' 
                 };

                 for (const param in paramToIdMap) {
                     if (params.has(param)) {
                         let value = decodeURIComponent(params.get(param));
                         if (['thanh_tien', 'tong_phat_sinh', 'khuyen_mai_tong', 'phai_thanh_toan', 'da_thanh_toan', 'con_lai'].includes(param)) {
                             value = parseFloat(value.replace(/,/g, '') || 0).toLocaleString('vi-VN');
                         }
                         
                         const ids = Array.isArray(paramToIdMap[param]) ? paramToIdMap[param] : [paramToIdMap[param]];
                         
                         if (param === 'website_studio') {
                             const aElement = document.getElementById(ids[0]);
                             if(aElement) {
                                 try {
                                     const websiteData = JSON.parse(value);
                                     aElement.href = websiteData.Url;
                                     aElement.textContent = websiteData.LinkText;
                                 } catch (e) {
                                     aElement.href = value;
                                     aElement.textContent = value;
                                 }
                             }
                             continue;
                         }

                         ids.forEach(id => {
                            const element = document.getElementById(id);
                             if (element) {
                                 element.textContent = value;
                             }
                         });
                     }
                 }
                 
                 if (params.has('logo_url')) {
                    const logoImg = document.getElementById('studio-logo-img');
                    if (logoImg) logoImg.src = decodeURIComponent(params.get('logo_url'));
                 }
                 
                 document.getElementById('payment-stk').textContent = params.get('stk') || 'N/A';
                 document.getElementById('payment-account-name').textContent = params.get('chu_tai_khoan') || 'N/A';
                 document.getElementById('payment-info').textContent = params.get('ma_hd') || 'N/A';
                 document.title = "HÄ " + params.get('ma_hd') + " - " + (params.get('ten_chi_nhanh') || '');

                 // === START: LÆ¯U Dá»® LIá»†U JSON VÃ€O BIáº¾N TOÃ€N Cá»¤C ===
                 if (params.has('chitiet_json')) { 
                    try { 
                        globalServiceData = JSON.parse(decodeURIComponent(params.get('chitiet_json')));
                        populateServiceTable(null); // Gá»i láº§n Ä‘áº§u khÃ´ng lá»c
                    } catch(e) { 
                        console.error("Error parsing JSON:", e); 
                    } 
                 }
                 // === END ===

                 generatePaymentQRCode({ bin: params.get('ma_bank'), accountNo: params.get('stk'), accountName: params.get('chu_tai_khoan'), amount: parseInt((params.get('con_lai') || "0").replace(/[^0-9]/g, ''), 10), info: params.get('ma_hd') });
                 generateContractQRCode(params.get('ma_hd')); 
                 const conLaiRaw = (params.get('con_lai') || "0").replace(/[^0-9]/g, '');
                 document.getElementById('amount-in-words').textContent = readNumberInVietnamese(conLaiRaw);
            }

            function runDemoMode() {
                 document.body.insertAdjacentHTML('beforeend', '<div style="position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg); font-size: 80pt; color: rgba(0, 0, 0, 0.05); font-weight: 700; text-transform: uppercase; pointer-events: none; z-index: 1000; display: block;">Báº¢N NHÃP</div>');
                 const demoParams = new URLSearchParams();
                 demoParams.set('logo_url', 'https://scontent.fsgn2-6.fna.fbcdn.net/v/t39.30808-6/274489412_1388888508225332_3112485830184052132_n.jpg?_nc_cat=110&ccb=1-7&_nc_sid=6ee11a&_nc_ohc=6UFIS_ClcLEQ7kNvwELXjBZ&_nc_oc=AdmyGu3tXEesz-U3QQ3TkufiXrAsnlpuJgRLwf0SHxStw3L-vpIGeaw4TZ6d2EkZaE4&_nc_zt=23&_nc_ht=scontent.fsgn2-6.fna&_nc_gid=BbGYZsNaWzblm0tLvHhfTQ&oh=00_AfWEb38bc0Un-ycVgv1XZO-tNTBfVmpCHfUALr49vuJCaQ&oe=68B1DBA0');
                 demoParams.set('ten_studio', '2H STUDIO');
                 demoParams.set('ten_chi_nhanh', '2H STUDIO - SÆ N TÃ‚Y');
                 demoParams.set('diachi_studio', '566 ChÃ¹a ThÃ´ng - SÆ¡n TÃ¢y - HÃ  Ná»™i');
                 demoParams.set('website_studio', 'http://2hstudio.vn/');
                 demoParams.set('email_studio', '2hstudio.wedding@gmail.com');
                 demoParams.set('dienthoai_studio', '0854623566');
                 demoParams.set('zalo_studio', '2H studio');
                 demoParams.set('ma_hd', 'HD-DEMO-001');
                 demoParams.set('ngay_hd', new Date().toLocaleDateString('vi-VN'));
                 demoParams.set('khach_hang', 'KHÃCH HÃ€NG DEMO');
                 demoParams.set('dien_thoai_kh', '0123456789');
                 demoParams.set('dia_chi_kh', 'HÃ  Ná»™i');
                 demoParams.set('nhan_vien', 'NHÃ‚N VIÃŠN DEMO');
                 demoParams.set('dien_thoai_nv', '0987654321');
                 demoParams.set('chuc_vu_nv', 'NhÃ¢n viÃªn');
                 demoParams.set('thanh_tien', '9500000');
                 demoParams.set('tong_phat_sinh', '0');
                 demoParams.set('khuyen_mai_tong', '500000');
                 demoParams.set('phai_thanh_toan', '9000000');
                 demoParams.set('da_thanh_toan', '8000000');
                 demoParams.set('con_lai', '1000000');
                 demoParams.set('ten_ky_kh', 'TÃªn KhÃ¡ch HÃ ng KÃ½');
                 demoParams.set('ten_ky_nv', 'TÃªn NhÃ¢n ViÃªn KÃ½');
                 demoParams.set('stk', '0501000130594');
                 demoParams.set('chu_tai_khoan', '2H STUDIO');
                 demoParams.set('ma_bank', '970436');
                 populateFromUrl(demoParams);
                 
                 globalServiceData = [{ sanpham: "GÃ³i chá»¥p Premium", chitiet: "GÃ³i", soluong: 1, thanhtien: 8900000, ghi_chu: "Bao gá»“m album", loai_dich_vu: "GÃ³i Chá»¥p" }, { sanpham: "VÃ¡y cÆ°á»›i Lux", chitiet: "ThuÃª ngÃ y cÆ°á»›i", soluong: 1, thanhtien: 2000000, ghi_chu: "MÃ£ vÃ¡y V01", loai_dich_vu: "Trang phá»¥c" }, { sanpham: "In áº£nh cá»•ng", chitiet: "Táº¥m", soluong: 1, thanhtien: 600000, ghi_chu: "KÃ­ch thÆ°á»›c 60x90", loai_dich_vu: "Sáº£n pháº©m láº»" }];
                 populateServiceTable(null);
            }

            // === START: Cáº¬P NHáº¬T HÃ€M POPULATE Vá»šI LOGIC Lá»ŒC ===
            function populateServiceTable(filterType) {
                 const tableBody = document.getElementById('service-table-body');
                 if (!tableBody) return;
                 tableBody.innerHTML = '';
                 
                 const dataToDisplay = filterType 
                    ? globalServiceData.filter(item => item.loai_dich_vu === filterType)
                    : globalServiceData;

                 dataToDisplay.forEach((item, index) => { 
                     const row = document.createElement('tr'); 
                     const thanhTienFormatted = (item.thanhtien || 0).toLocaleString('vi-VN');
                     
                     const chiTietFormatted = (item.chitiet || '').replace(/\\n/g, '<br>');
                     const ghiChuFormatted = (item.ghi_chu || '').replace(/\\n/g, '<br>');

                     row.innerHTML = `<td style="text-align: center;">${index + 1}</td>
                                      <td><span class="dynamic-data">${item.sanpham || ''}</span></td>
                                      <td><span class="dynamic-data">${chiTietFormatted}</span></td>
                                      <td style="text-align: center;"><span class="dynamic-data">${item.soluong || 0}</span></td>
                                      <td class="price-cell"><span class="dynamic-data">${thanhTienFormatted}</span></td>
                                      <td><span class="dynamic-data">${ghiChuFormatted}</span></td>`; 
                     tableBody.appendChild(row); 
                });
            }
            // === END ===

            function generatePaymentQRCode(data){const qrContainer=document.getElementById("payment-qr-code-container"),amount=(data.amount||0).toString().replace(/,/g,""),bankBin=data.bin||"",accountNumber=data.accountNo||"",accountName=data.accountName||"";if(!bankBin||!accountNumber||parseInt(amount)<0)return void(qrContainer.innerHTML='<p style="color: red; font-size: 0.9em;">Lá»—i: Dá»¯ liá»‡u thanh toÃ¡n khÃ´ng há»£p lá»‡.</p>');const accountNameForURL=encodeURIComponent(removeVietnameseTones(accountName).toUpperCase()),qrApiUrl=`https://img.vietqr.io/image/${bankBin}-${accountNumber}-compact.png?amount=${amount}&addInfo=${encodeURIComponent(data.info||"")}&accountName=${accountNameForURL}`,qrImage=new Image;qrImage.crossOrigin="anonymous",qrContainer.innerHTML="Äang táº¡o mÃ£ QR...",qrImage.onload=()=>{qrContainer.innerHTML="",qrContainer.appendChild(qrImage)},qrImage.onerror=()=>{qrContainer.innerHTML='<p style="color: red; font-size: 0.9em;">KhÃ´ng thá»ƒ táº¡o mÃ£ QR. Vui lÃ²ng kiá»ƒm tra láº¡i STK/NgÃ¢n hÃ ng.</p>'},qrImage.src=qrApiUrl}
            function generateContractQRCode(e){const t=document.getElementById("contract-qr-container");if(!t||!e)return;const r=`https://api.qrserver.com/v1/create-qr-code/?size=65x65&data=${encodeURIComponent(e)}&qzone=1&format=svg`,n=new Image;n.src=r,n.alt=`QR Code for ${e}`,t.innerHTML="",t.appendChild(n)}
            
            function downloadAsPdf(contractType, fileNamePrefix) {
                renderContractTerms(contractType); 
                setTimeout(() => {
                    const dropdownBtns = document.querySelectorAll('.dropdown-btn');
                    const element = document.getElementById('a4-page-content');
                    const originalShadow = element.style.boxShadow;
                    dropdownBtns.forEach(btn => btn.disabled = true );
                    document.getElementById('download-dropdown-btn').textContent = 'Äang xá»­ lÃ½...';
                    element.style.boxShadow = 'none';
                    const filename = `${fileNamePrefix}_${document.getElementById('contract-id').textContent.trim()}_${document.getElementById('customer-name').textContent.trim()}.pdf`;
                    const opt = { 
                        margin: 10, 
                        filename: filename, 
                        image: { type: 'jpeg', quality: 0.98 }, 
                        html2canvas:  { scale: 2, useCORS: true, logging: false }, 
                        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } 
                    };
                    html2pdf().from(element).set(opt).save().then(() => {
                        element.style.boxShadow = originalShadow;
                        dropdownBtns.forEach(btn => btn.disabled = false);
                        document.getElementById('download-dropdown-btn').innerHTML = 'ğŸ“„ Táº£i vá» PDF â–¾';
                        closeAllDropdowns();
                    }).catch(err => {
                        console.error("PDF generation failed:", err);
                        alert("Lá»—i khi táº¡o PDF. Vui lÃ²ng thá»­ láº¡i.");
                        element.style.boxShadow = originalShadow;
                        dropdownBtns.forEach(btn => btn.disabled = false);
                        document.getElementById('download-dropdown-btn').innerHTML = 'ğŸ“„ Táº£i vá» PDF â–¾';
                        closeAllDropdowns();
                    });
                }, 100);
            }
            
            function renderContractTerms(type) {
                const container = document.querySelector('.terms-section');
                const titleElement = document.getElementById('main-contract-title');
                if (!container || !titleElement) return;

                if (type === 'dress') {
                    container.innerHTML = CONTRACT_TERMS_DRESS;
                    titleElement.textContent = 'Há»¢P Äá»’NG CUNG Cáº¤P TRANG PHá»¤C';
                    populateServiceTable('Trang phá»¥c'); // Lá»c theo 'Trang phá»¥c'
                } else if (type === 'family') {
                    container.innerHTML = CONTRACT_TERMS_FAMILY;
                    titleElement.textContent = 'Há»¢P Äá»’NG BABY & GIA ÄÃŒNH';
                    populateServiceTable(null); // KhÃ´ng lá»c
                } else { 
                    container.innerHTML = CONTRACT_TERMS_SERVICE;
                    titleElement.textContent = 'Há»¢P Äá»’NG CUNG Cáº¤P Dá»ŠCH Vá»¤';
                    populateServiceTable(null); // KhÃ´ng lá»c
                }
                
                const urlParams = new URLSearchParams(window.location.search);
                const ten_ky_kh = urlParams.get('ten_ky_kh') || (urlParams.has('ma_hd') ? '' : 'TÃªn KhÃ¡ch HÃ ng KÃ½');
                const ten_ky_nv = urlParams.get('ten_ky_nv') || (urlParams.has('ma_hd') ? '' : 'TÃªn NhÃ¢n ViÃªn KÃ½');
                const ten_studio = urlParams.get('ten_studio') || (urlParams.has('ma_hd') ? '' : '2H STUDIO');

                if (document.getElementById('customer-signature-name')) {
                    document.getElementById('customer-signature-name').textContent = ten_ky_kh;
                }
                if (document.getElementById('staff-signature-name')) {
                    document.getElementById('staff-signature-name').textContent = ten_ky_nv;
                }
                if (document.getElementById('studio-signature-name-top')) {
                    document.getElementById('studio-signature-name-top').textContent = ten_studio;
                }
                if (document.getElementById('studio-signature-name-bottom')) {
                    document.getElementById('studio-signature-name-bottom').textContent = ten_studio;
                }
            }

            function injectHTMLStructure() {
                 document.querySelector(".header-content").innerHTML = `<header class="header"><div class="header-left"><div class="logo"><img id="studio-logo-img" alt="Studio Logo" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;"></div><div class="studio-info"><h2 id="studio-name"></h2><p><strong>Äá»‹a chá»‰:</strong> <span id="studio-address"></span></p><p><strong>Website:</strong> <a id="studio-website" href="#" target="_blank"></a> | <strong>Email:</strong> <span id="studio-email"></span></p><p><strong>Äiá»‡n thoáº¡i:</strong> <span id="studio-phone"></span> | <strong>Zalo:</strong> <span id="studio-zalo"></span></p></div></div><div id="contract-qr-container" title="MÃ£ há»£p Ä‘á»“ng"></div></header>`;
                 document.querySelector(".main-content").innerHTML = `<div><h1 class="main-title" id="main-contract-title">Há»¢P Äá»’NG CUNG Cáº¤P Dá»ŠCH Vá»¤</h1><div class="contract-meta">Sá»‘: <span id="contract-id" class="dynamic-data"></span> | NgÃ y: <span id="contract-date" class="dynamic-data"></span></div><p><strong><span id="branch-name-main"></span></strong> Gá»­i tá»›i quÃ½ khÃ¡ch hÃ ng hoÃ¡ Ä‘Æ¡n dá»‹ch vá»¥ nhÆ° sau:</p><div class="info-grid" style="display:flex; justify-content:space-between; margin-bottom:20px;"><div class="customer-info" style="width:50%;"><p><strong>KhÃ¡ch hÃ ng:</strong> <span id="customer-name" class="dynamic-data"></span></p><p><strong>Äiá»‡n thoáº¡i:</strong> <span id="customer-phone" class="dynamic-data"></span></p><p><strong>Äá»‹a chá»‰:</strong> <span id="customer-address" class="dynamic-data"></span></p></div><div class="staff-info" style="width: 40%;"><p><strong>NhÃ¢n viÃªn:</strong> <span id="staff-name" class="dynamic-data"></span></p><p><strong>Äiá»‡n thoáº¡i NV:</strong> <span id="staff-phone" class="dynamic-data"></span></p><p><strong>Chá»©c Vá»¥:</strong> <span id="staff-title" class="dynamic-data"></span></p></div></div><table style="table-layout: fixed;"><colgroup><col style="width: 7%;"><col style="width: 22%;"><col style="width: 35.5%;"><col style="width: 8%;"><col style="width: 13.5%;"><col style="width: 14%;"></colgroup><thead><tr><th>STT</th><th>Sáº£n pháº©m</th><th>Chi tiáº¿t</th><th>Sá»‘ lÆ°á»£ng</th><th>ThÃ nh tiá»n</th><th>Ghi chÃº</th></tr></thead><tbody id="service-table-body"></tbody></table></div><div class="summary-and-payment"><div class="qr-payment-section"><div class="qr-payment-content"><div class="qr-code" id="payment-qr-code-container"></div><div class="payment-instructions"><p style="font-weight: bold;">QUÃ‰T MÃƒ QR Äá»‚ THANH TOÃN:</p><p>- STK: <span id="payment-stk" class="dynamic-data"></span></p><p>- Chá»§ tÃ i khoáº£n: <span id="payment-account-name" class="dynamic-data"></span></p><p>- Ná»™i dung CK: <span id="payment-info" class="dynamic-data"></span></p></div></div></div><div class="summary-section"><table class="summary-table"><tbody><tr><td>ThÃ nh tiá»n:</td><td style="text-align:right;"><span id="subtotal" class="dynamic-data"></span></td></tr><tr><td>Khuyáº¿n mÃ£i:</td><td style="text-align:right;"><span id="total-promotion" class="dynamic-data"></span></td></tr><tr><td>PhÃ¡t sinh:</td><td style="text-align:right;"><span id="additional-cost" class="dynamic-data"></span></td></tr><tr><td style="font-weight: 700;">Pháº£i TT:</td><td style="text-align:right; font-weight: 700;"><span id="total-due" class="dynamic-data"></span></td></tr><tr><td>ÄÃ£ TT:</td><td style="text-align:right;"><span id="amount-paid" class="dynamic-data"></span></td></tr><tr><td class="highlight-red">CÃ²n Láº¡i:</td><td style="text-align:right;"><span class="dynamic-data highlight-red" id="amount-remaining"></span></td></tr><tr><td colspan="2">(Báº±ng chá»¯: <span id="amount-in-words" class="dynamic-data"></span>)</td></tr></tbody></table></div></div><div class="terms-section"></div>`;
            }
        });
    </script>
</body>
</html>
