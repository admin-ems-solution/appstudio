<button id="print-action" class="action-btn">ğŸ–¨ï¸ In Há»£p Äá»“ng</button>
    <button id="download-pdf-action" class="action-btn download-pdf-btn">ğŸ“„ Táº£i vá» PDF</button>
    <button id="download-img-action" class="action-btn download-img-btn">ğŸ–¼ï¸ Táº£i HÃ¬nh áº¢nh</button>

</div>
<div class="page-wrapper">
    <div class="a4-page" id="a4-page-content">
        <table id="print-container">
            <thead id="page-header"><tr><td><div class="header-content"></div></td></tr></thead>
            <tbody><tr><td><div class="main-content"></div></td></tr></tbody>
            <tfoot id="page-footer"><tr><td><div class="footer-content"><span class="page-number"></span></div></td></tr></tfoot>
        </table>
    </div>
</div>

<script>
    let globalServiceData = []; 
    let currentContractType = 'service';

    const CONTRACT_TERMS_SERVICE = `
        <div class="print-block">
            <h3>HÃ¬nh thá»©c thanh toÃ¡n:</h3>
            <ul><li>Láº§n 1 : 20% ( Ä‘áº·t cá»c )</li><li>Láº§n 2 : 70% (cuá»‘i buá»•i chá»¥p hÃ¬nh)</li><li>Láº§n 3 : 10% ( khi nháº­n áº£nh in )</li></ul>
            <p><strong>PhÆ°Æ¡ng thá»©c thanh toÃ¡n:</strong> Chuyá»ƒn khoáº£n hoáº·c Tiá»n máº·t</p>
            <p><strong>Hai bÃªn thá»‘ng nháº¥t kÃ½ há»£p Ä‘á»“ng vá»›i nhá»¯ng Ä‘iá»u khoáº£n nhÆ° sau:</strong></p>
        </div>
        <div class="print-block">
            <h3>Äiá»u 1: TrÃ¡ch nhiá»‡m vÃ  quyá»n lá»£i cá»§a cÃ¡c BÃªn</h3>
            <p><strong>1.1. TrÃ¡ch nhiá»‡m vÃ  quyá»n lá»£i cá»§a bÃªn A:</strong></p>
            <ul><li>Náº¿u bÃªn A cÃ³ nhu cáº§u thay Ä‘á»•i gÃ³i chá»¥p hoáº·c cÃ¡c dá»‹ch vá»¥ phÃ¡t sinh phÃ­, bÃªn B sáº½ há»— trá»£ thay Ä‘á»•i sang gÃ³i chá»¥p hoáº·c dá»‹ch vá»¥ cÃ³ giÃ¡ trá»‹ tÆ°Æ¡ng Ä‘Æ°Æ¡ng hoáº·c cao hÆ¡n.</li><li>BÃªn A cÃ³ trÃ¡ch nhiá»‡m thanh toÃ¡n cho BÃªn B phÃ­ dá»‹ch vá»¥ Ä‘Ãºng háº¡n theo hÃ¬nh thá»©c thanh toÃ¡n nÃªu trÃªn.</li><li>BÃªn A Ä‘Æ°á»£c nháº­n toÃ n bá»™ sáº£n pháº©m theo pháº§n chi tiáº¿t cá»§a há»£p Ä‘á»“ng nÃ y.</li><li>TrÆ°á»ng há»£p bÃªn A há»§y há»£p Ä‘á»“ng sáº½ máº¥t toÃ n bá»™ tiá»n Ä‘áº·t cá»c.</li><li>BÃªn A Ä‘Æ°á»£c quyá»n hoÃ£n chá»¥p hÃ¬nh (quay video) 01 láº§n mÃ  khÃ´ng bá»‹ tÃ­nh phÃ­ nhÆ°ng pháº£i bÃ¡o trÆ°á»›c cho bÃªn B muá»™n nháº¥t 3 ngÃ y trÆ°á»›c ngÃ y chá»¥p.</li><li>Náº¿u bÃªn A tiáº¿p tá»¥c phÃ¡t sinh viá»‡c hoÃ£n lá»‹ch thÃ¬ sáº½ chá»‹u chi phÃ­ phÃ¡t sinh: 1.000.000 VND/láº§n.</li><li>BÃªn A Ä‘Æ°á»£c quyá»n hoÃ£n chá»¥p hÃ¬nh 01 láº§n vÃ o ngÃ y chá»¥p trong trÆ°á»ng há»£p khÃ¡ch quan thá»i tiáº¿t xáº¥u, tuy nhiÃªn BÃªn A pháº£i thanh toÃ¡n cÃ¡c chi phÃ­ cá»‘ Ä‘á»‹nh Ä‘Ã£ phÃ¡t sinh trong ngÃ y nÃ y - VD: Hoa tay, thuÃª xe, trang Ä‘iá»ƒm.</li><li>BÃªn A tá»± chá»‹u trÃ¡ch nhiá»‡m vá» an toÃ n cÃ¡ nhÃ¢n trong quÃ¡ trÃ¬nh chá»¥p áº£nh, quay phim.</li><li>TrÆ°á»ng há»£p bÃªn A há»§y há»£p Ä‘á»“ng sau khi chá»¥p Ä‘Ã£ copy toÃ n bá»™ file gá»‘c sáº½ khÃ´ng nháº­n láº¡i Ä‘Æ°á»£c tiá»n thanh toÃ¡n 2 láº§n Ä‘áº·t cá»c.</li><li>TrÆ°á»ng há»£p bÃªn A muá»‘n copy file Raw, sáº½ thanh toÃ¡n háº¿t phÃ­ dá»‹ch vá»¥.</li></ul>
            <p><strong>1.2. TrÃ¡ch nhiá»‡m vÃ  quyá»n lá»£i cá»§a BÃªn B:</strong></p>
            <ul><li>BÃªn B cÃ³ trÃ¡ch nhiá»‡m thá»±c hiá»‡n Ä‘áº§y Ä‘á»§ cÃ¡c ná»™i dung nghiá»‡p vá»¥ tÆ°Æ¡ng á»©ng vá»›i cÃ¡c dá»‹ch vá»¥ kÃ½ káº¿t, Ä‘Æ°á»£c niÃªm yáº¿t cÃ´ng khai kÃ¨m theo bÃ¡o giÃ¡.</li><li>BÃªn B Ä‘áº£m báº£o thá»±c hiá»‡n há»£p Ä‘á»“ng nÃ y vá»›i cháº¥t lÆ°á»£ng cao vÃ  nhiá»‡t tÃ¬nh vá»›i cÃ´ng viá»‡c, Ä‘Ãºng nguyÃªn táº¯c minh báº¡ch, trung thá»±c, uy tÃ­n, khÃ¡ch quan vÃ  bÃ­ máº­t vá» thÃ´ng tin cÃ¡ nhÃ¢n cá»§a khÃ¡ch hÃ ng.</li></ul>
        </div>
        <div class="print-block">
            <h3>Äiá»u 2: Cam káº¿t thá»±c hiá»‡n</h3>
            <ul><li>Hai bÃªn cam káº¿t thá»±c hiá»‡n táº¥t cáº£ cÃ¡c Ä‘iá»u khoáº£n Ä‘Ã£ ghi trong há»£p Ä‘á»“ng.</li><li>Trong quÃ¡ trÃ¬nh thá»±c hiá»‡n náº¿u gáº·p khÃ³ khÄƒn hai BÃªn pháº£i ká»‹p thá»i thÃ´ng bÃ¡o cho nhau, cáº§n thiáº¿t thÃ¬ trao Ä‘á»•i báº±ng vÄƒn báº£n tÃ¬m giáº£i phÃ¡p thÃ­ch há»£p.</li></ul>
            <p>Há»£p Ä‘á»“ng nÃ y Ä‘Æ°á»£c láº­p thÃ nh 02 báº£n cÃ³ giÃ¡ trá»‹ nhÆ° nhau, BÃªn A giá»¯ 01 báº£n, BÃªn B giá»¯ 01 báº£n vÃ  cÃ³ hiá»‡u lá»±c ká»ƒ tá»« ngÃ y kÃ½ há»£p Ä‘á»“ng, cho Ä‘áº¿n khi bÃªn B hoÃ n thÃ nh cÃ¡c dá»‹ch vá»¥ quy Ä‘á»‹nh táº¡i Äiá»u 1 vÃ  BÃªn A thanh toÃ¡n xong phÃ­ dá»‹ch vá»¥ cho BÃªn B thÃ¬ há»£p Ä‘á»“ng nÃ y xem nhÆ° Ä‘Æ°á»£c thanh lÃ½ hoáº·c cáº£ hai bÃªn cÃ¹ng thá»‘ng nháº¥t cháº¥m dá»©t há»£p Ä‘á»“ng báº±ng vÄƒn báº£n.</p>
            <ul><li>CÃ¡c Ä‘iá»u khoáº£n dá»‹ch vá»¥ Ä‘Æ°á»£c sá»­ dá»¥ng trong vÃ²ng 1 nÄƒm tÃ­nh tá»« ngÃ y kÃ½ há»£p Ä‘á»“ng.</li></ul>
        </div>
        <div class="signature-block print-block">
            <div class="customer-signature"><p style="font-weight: 700;">KhÃ¡ch hÃ ng</p><p style="font-size: 9pt; color: #6c757d; font-style: italic;">(KÃ½ vÃ  ghi há» tÃªn)</p><p class="name" id="customer-signature-name" class="dynamic-data"></p></div><div class="staff-signature"><p style="font-weight: 700;">NhÃ¢n viÃªn tÆ° váº¥n</p><p style="font-size: 9pt; color: #6c757d; font-style: italic;">(KÃ½ vÃ  ghi há» tÃªn)</p><p class="name" id="staff-signature-name" class="dynamic-data"></p></div><div class="studio-signature"><p style="font-weight: 700;" id="studio-signature-name-top"></p><p style="font-size: 9pt; color: #6c757d; font-style: italic;">(KÃ½ vÃ  ghi há» tÃªn)</p><p class="name" id="studio-signature-name-bottom"></p></div>
        </div>`;
        
    const CONTRACT_TERMS_DRESS = `
        <div class="print-block">
            <h3>HÃ¬nh thá»©c thanh toÃ¡n:</h3>
            <p><strong>HÃ¬nh thá»©c cá»c lÃ m tin:</strong></p>
            <ul style="padding-left: 40px; list-style-type: 'â˜ '; "><li>Äáº·t cá»c cÄƒn cÆ°á»›c, giáº¥y tá» xe</li><li>Äáº·t cá»c tiá»n máº·t</li></ul>
            <p><strong>Hai bÃªn thá»‘ng nháº¥t kÃ½ há»£p Ä‘á»“ng vá»›i nhá»¯ng Ä‘iá»u khoáº£n nhÆ° sau:</strong></p>
        </div>
        <div class="print-block">
            <h3>Äiá»u 1: Ná»™i dung dá»‹ch vá»¥ vÃ  hiá»‡n tráº¡ng sáº£n pháº©m</h3>
            <p>BÃªn B Ä‘á»“ng Ã½ cung cáº¥p cho BÃªn A cÃ¡c dá»‹ch vá»¥ nhÆ° báº£ng chi tiáº¿t sáº£n pháº©m.</p>
            <p><strong>Hiá»‡n tráº¡ng vÃ¡y:</strong> ...............................................................................................................................</p>
            <p><strong>Phá»¥ kiá»‡n nháº­n Ä‘Æ°á»£c:</strong> ....................................................................................................................</p>
        </div>
        <div class="print-block">
            <h3>Äiá»u 2: TrÃ¡ch nhiá»‡m vÃ  quyá»n lá»£i cá»§a cÃ¡c BÃªn</h3>
            <p><strong>2.1. TrÃ¡ch nhiá»‡m vÃ  quyá»n lá»£i cá»§a bÃªn A:</strong></p>
            <ul><li>BÃªn A cÃ³ trÃ¡ch nhiá»‡m thanh toÃ¡n cho BÃªn B phÃ­ dá»‹ch vá»¥ Ä‘Ãºng háº¡n.</li><li>TrÆ°á»ng há»£p bÃªn A há»§y há»£p Ä‘á»“ng vÃ¡y sáº½ khÃ´ng Ä‘Æ°á»£c hoÃ n láº¡i phÃ­ thanh toÃ¡n.</li><li>BÃªn A Ä‘Æ°á»£c nháº­n toÃ n bá»™ sáº£n pháº©m theo pháº§n chi tiáº¿t cá»§a há»£p Ä‘á»“ng nÃ y.</li><li>TrÆ°á»ng há»£p bÃªn A lÃ m vÃ¡y bá»‹ dÃ­nh rÆ°á»£u vang, pháº©m mÃ u nhiá»u trÃªn 1 bÃ n tay sáº½ kháº¥u hao 500-800k tÃ¹y theo cháº¥t liá»‡u vÃ¡y.</li><li>TrÆ°á»ng há»£p bÃªn A lÃ m máº¥t hoáº·c hÆ° háº¡i hoÃ n toÃ n vÃ¡y sáº½ Ä‘á»n toÃ n bá»™ phÃ­ cá»c lÃ m tin.</li><li>TrÆ°á»ng há»£p bÃªn A lÃ m hÆ° há»ng vÃ¡y, bá»‹ dÃ­nh cháº¥t pháº©m khÃ´ng giáº·t Ä‘Æ°á»£c, vÃ¡y bá»‹ quÃ¡ báº©n, hiá»‡n tráº¡ng vÃ¡y khÃ´ng Ä‘Æ°á»£c nhÆ° cam káº¿t á»Ÿ Ä‘iá»u 1:<ul style="padding-left: 20px; list-style-type: circle;"><li>Studio giá»¯ láº¡i vÃ¡y vÃ  cá»c vÃ¡y (chá» xá»­ lÃ½ 4-5 ngÃ y), xá»­ lÃ½ Ä‘Æ°á»£c sáº½ hoÃ n láº¡i phÃ­ cá»c cho dÃ¢u rá»ƒ.</li><li>TrÆ°á»ng há»£p vÃ¡y khÃ´ng xá»­ lÃ½ Ä‘Æ°á»£c studio buá»™c pháº£i trá»« kháº¥u hao vÃ o phÃ­ cá»c vÃ¡y (30% - 80% phÃ­ cá»c vÃ¡y).</li></ul></li><li>TrÆ°á»ng há»£p bÃªn A khÃ´ng tráº£ Ä‘á»“ Ä‘Ãºng ngÃ y trong há»£p Ä‘á»“ng, chi phÃ­ phÃ¡t sinh lÃ  500k/ 1 ngÃ y.</li><li>TrÆ°á»ng há»£p bÃªn A tá»± Ã½ sá»­a Ä‘á»“ khi chÆ°a cÃ³ sá»± Ä‘á»“ng Ã½ cá»§a bÃªn B, thÃ¬ sáº½ Ä‘á»n giÃ¡ trá»‹ tÆ°Æ¡ng á»©ng vá»›i Ä‘á»“ Ä‘Ã£ sá»­a.</li><li>Khi tráº£ vÃ¡y kÃ¨m theo há»£p Ä‘á»“ng láº¥y vÃ¡y.</li></ul>
            <p><strong>2.2. TrÃ¡ch nhiá»‡m vÃ  quyá»n lá»£i cá»§a BÃªn B:</strong></p>
            <ul><li>BÃªn B cÃ³ trÃ¡ch nhiá»‡m thá»±c hiá»‡n Ä‘áº§y Ä‘á»§ cÃ¡c ná»™i dung nghiá»‡p vá»¥ tÆ°Æ¡ng á»©ng vá»›i cÃ¡c dá»‹ch vá»¥ kÃ½ káº¿t, Ä‘Æ°á»£c niÃªm yáº¿t cÃ´ng khai kÃ¨m theo bÃ¡o giÃ¡, sau khi nháº­n Ä‘Æ°á»£c hiá»‡n tráº¡ng vÃ¡y theo Ä‘Ãºng quy Ä‘á»‹nh tiÃªu chuáº©n nhÆ° Ä‘iá»u 1 sáº½ hoÃ n láº¡i phÃ­ Ä‘áº·t cá»c cho bÃªn A.</li><li>BÃªn B Ä‘áº£m báº£o thá»±c hiá»‡n há»£p Ä‘á»“ng nÃ y vá»›i cháº¥t lÆ°á»£ng cao vÃ  nhiá»‡t tÃ¬nh vá»›i cÃ´ng viá»‡c, Ä‘Ãºng nguyÃªn táº¯c minh báº¡ch, trung thá»±c, uy tÃ­n, khÃ¡ch quan vÃ  bÃ­ máº­t vá» thÃ´ng tin cÃ¡ nhÃ¢n cá»§a khÃ¡ch hÃ ng.</li></ul>
        </div>
        <div class="print-block">
            <h3>Äiá»u 3: Cam káº¿t thá»±c hiá»‡n</h3>
            <ul><li>Hai bÃªn cam káº¿t thá»±c hiá»‡n táº¥t cáº£ cÃ¡c Ä‘iá»u khoáº£n Ä‘Ã£ ghi trong há»£p Ä‘á»“ng.</li><li>Trong quÃ¡ trÃ¬nh thá»±c hiá»‡n náº¿u gáº·p khÃ³ khÄƒn hai BÃªn pháº£i ká»‹p thá»i thÃ´ng bÃ¡o cho nhau, cáº§n thiáº¿t thÃ¬ trao Ä‘á»•i báº±ng vÄƒn báº£n tÃ¬m giáº£i phÃ¡p thÃ­ch há»£p.</li></ul>
            <p>Há»£p Ä‘á»“ng nÃ y Ä‘Æ°á»£c láº­p thÃ nh 02 báº£n cÃ³ giÃ¡ trá»‹ nhÆ° nhau, BÃªn A giá»¯ 01 báº£n, BÃªn B giá»¯ 01 báº£n vÃ  cÃ³ hiá»‡u lá»±c ká»ƒ tá»« ngÃ y kÃ½ há»£p Ä‘á»“ng, cho Ä‘áº¿n khi bÃªn B hoÃ n thÃ nh cÃ¡c dá»‹ch vá»¥ quy Ä‘á»‹nh táº¡i Äiá»u 1 vÃ  BÃªn A thanh toÃ¡n xong phÃ­ dá»‹ch vá»¥ cho BÃªn B thÃ¬ há»£p Ä‘á»“ng nÃ y xem nhÆ° Ä‘Æ°á»£c thanh lÃ½ hoáº·c cáº£ hai bÃªn cÃ¹ng thá»‘ng nháº¥t cháº¥m dá»©t há»£p Ä‘á»“ng báº±ng vÄƒn báº£n.</p>
        </div>
        <div class="signature-block print-block">
            <div class="customer-signature"><p style="font-weight: 700;">KhÃ¡ch hÃ ng</p><p style="font-size: 9pt; color: #6c757d; font-style: italic;">(KÃ½ vÃ  ghi há» tÃªn)</p><p class="name" id="customer-signature-name" class="dynamic-data"></p></div><div class="staff-signature"><p style="font-weight: 700;">NhÃ¢n viÃªn tÆ° váº¥n</p><p style="font-size: 9pt; color: #6c757d; font-style: italic;">(KÃ½ vÃ  ghi há» tÃªn)</p><p class="name" id="staff-signature-name" class="dynamic-data"></p></div><div class="studio-signature"><p style="font-weight: 700;" id="studio-signature-name-top"></p><p style="font-size: 9pt; color: #6c757d; font-style: italic;">(KÃ½ vÃ  ghi há» tÃªn)</p><p class="name" id="studio-signature-name-bottom"></p></div>
        </div>`;
    
    const CONTRACT_TERMS_FAMILY = `
        <div class="print-block">
            <h3>HÃ¬nh thá»©c thanh toÃ¡n:</h3>
            <ul><li>Láº§n 1: 50% (Ä‘áº·t cá»c)</li><li>Láº§n 2: 50% (cuá»‘i buá»•i chá»¥p)</li></ul>
            <p><strong>Hai bÃªn thá»‘ng nháº¥t kÃ½ há»£p Ä‘á»“ng vá»›i nhá»¯ng Ä‘iá»u khoáº£n nhÆ° sau:</strong></p>
        </div>
        <div class="print-block">
             <h3>Äiá»u 1: Äiá»u khoáº£n chung</h3>
            <ul><li>BÃªn A cÃ³ trÃ¡ch nhiá»‡m thanh toÃ¡n cho bÃªn B phÃ­ dá»‹ch vá»¥ Ä‘Ãºng háº¡n theo hÃ¬nh thá»©c thanh toÃ¡n nÃªu trÃªn.</li><li>BÃªn A chá»‹u rá»§i ro sáº£n pháº©m theo chi tiáº¿t cá»§a há»£p Ä‘á»“ng.</li><li>TrÆ°á»ng há»£p bÃªn A huá»· há»£p Ä‘á»“ng sáº½ máº¥t toÃ n bá»™ phÃ­ cá»c.</li><li>BÃªn A Ä‘Æ°á»£c quyá»n chá»n chá»¥p hÃ¬nh 1 láº§n mÃ  khÃ´ng bá»‹ tÃ­nh phÃ­ nhÆ°ng pháº£i bÃ¡o trÆ°á»›c ngÃ y chá»¥p 5 ngÃ y.</li><li>BÃªn B Ä‘áº£m báº£o thá»±c hiá»‡n há»£p Ä‘á»“ng nÃ y vá»›i cháº¥t lÆ°á»£ng cao vÃ  nhiá»‡t tÃ¬nh, vá»›i cÃ´ng viá»‡c, trung thá»±c, uy tÃ­n, khÃ¡ch quan vÃ  báº£o máº­t vá» thÃ´ng tin cá»§a khÃ¡ch hÃ ng.</li></ul>
            <p><strong>LÆ°u Ã½:</strong> GÃ³i chá»¥p chá»‰ Ã¡p dá»¥ng cho cÃ¡c trang phá»¥c vÃ  concept cÃ³ sáºµn táº¡i studio, cÃ¡c concept khÃ¡c theo sá»Ÿ thÃ­ch setup thÃªm cá»§a khÃ¡ch sáº½ tá»± thuÃª hoáº·c studio thuÃª há»™ vÃ  tráº£ phÃ­.</p>
        </div>
        <div class="print-block">
            <h3>Äiá»u 2: Cam káº¿t thá»±c hiá»‡n</h3>
            <ul><li>Hai bÃªn cam káº¿t thá»±c hiá»‡n táº¥t cáº£ cÃ¡c Ä‘iá»u khoáº£n Ä‘Ã£ ghi trong há»£p Ä‘á»“ng.</li><li>Trong quÃ¡ trÃ¬nh thá»±c hiá»‡n náº¿u gáº·p khÃ³ khÄƒn hai BÃªn pháº£i ká»‹p thá»i thÃ´ng bÃ¡o cho nhau, cáº§n thiáº¿t thÃ¬ trao Ä‘á»•i báº±ng vÄƒn báº£n tÃ¬m giáº£i phÃ¡p thÃ­ch há»£p.</li></ul>
            <p>Há»£p Ä‘á»“ng nÃ y Ä‘Æ°á»£c láº­p thÃ nh 02 báº£n cÃ³ giÃ¡ trá»‹ nhÆ° nhau, BÃªn A giá»¯ 01 báº£n, BÃªn B giá»¯ 01 báº£n vÃ  cÃ³ hiá»‡u lá»±c ká»ƒ tá»« ngÃ y kÃ½ há»£p Ä‘á»“ng, cho Ä‘áº¿n khi bÃªn B hoÃ n thÃ nh cÃ¡c dá»‹ch vá»¥ quy Ä‘á»‹nh táº¡i Äiá»u 1 vÃ  BÃªn A thanh toÃ¡n xong phÃ­ dá»‹ch vá»¥ cho BÃªn B thÃ¬ há»£p Ä‘á»“ng nÃ y xem nhÆ° Ä‘Æ°á»£c thanh lÃ½ hoáº·c cáº£ hai bÃªn cÃ¹ng thá»‘ng nháº¥t cháº¥m dá»©t há»£p Ä‘á»“ng báº±ng vÄƒn báº£n.</p>
            <ul><li>CÃ¡c Ä‘iá»u khoáº£n dá»‹ch vá»¥ Ä‘Æ°á»£c sá»­ dá»¥ng trong vÃ²ng 1 nÄƒm tÃ­nh tá»« ngÃ y kÃ½ há»£p Ä‘á»“ng.</li></ul>
        </div>
         <div class="signature-block print-block">
            <div class="customer-signature"><p style="font-weight: 700;">KhÃ¡ch hÃ ng</p><p style="font-size: 9pt; color: #6c757d; font-style: italic;">(KÃ½ vÃ  ghi há» tÃªn)</p><p class="name" id="customer-signature-name" class="dynamic-data"></p></div><div class="staff-signature"><p style="font-weight: 700;">NhÃ¢n viÃªn tÆ° váº¥n</p><p style="font-size: 9pt; color: #6c757d; font-style: italic;">(KÃ½ vÃ  ghi há» tÃªn)</p<p class="name" id="staff-signature-name" class="dynamic-data"></p></div><div class="studio-signature"><p style="font-weight: 700;" id="studio-signature-name-top"></p><p style="font-size: 9pt; color: #6c757d; font-style: italic;">(KÃ½ vÃ  ghi há» tÃªn)</p><p class="name" id="studio-signature-name-bottom"></p></div>
        </div>`;

    function removeVietnameseTones(str) {if(!str)return"";str=str.replace(/Ã |Ã¡|áº¡|áº£|Ã£|Ã¢|áº§|áº¥|áº­|áº©|áº«|Äƒ|áº±|áº¯|áº·|áº³|áºµ/g,"a");str=str.replace(/Ã¨|Ã©|áº¹|áº»|áº½|Ãª|á»|áº¿|á»‡|á»ƒ|á»…/g,"e");str=str.replace(/Ã¬|Ã­|á»‹|á»‰|Ä©/g,"i");str=str.replace(/Ã²|Ã³|á»|á»|Ãµ|Ã´|á»“|á»‘|á»™|á»•|á»—|Æ¡|á»|á»›|á»£|á»Ÿ|á»¡/g,"o");str=str.replace(/Ã¹|Ãº|á»¥|á»§|Å©|Æ°|á»«|á»©|á»±|á»­|á»¯/g,"u");str=str.replace(/á»³|Ã½|á»µ|á»·|á»¹/g,"y");str=str.replace(/Ä‘/g,"d");str=str.replace(/Ã€|Ã|áº |áº¢|Ãƒ|Ã‚|áº¦|áº¤|áº¬|áº¨|áºª|Ä‚|áº°|áº®|áº¶|áº²|áº´/g,"A");str=str.replace(/Ãˆ|Ã‰|áº¸|áºº|áº¼|ÃŠ|á»€|áº¾|á»†|á»‚|á»„/g,"E");str=str.replace(/ÃŒ|Ã|á»Š|á»ˆ|Ä¨/g,"I");str=str.replace(/Ã’|Ã“|á»Œ|á»|Ã•|Ã”|á»’|á»|á»˜|á»”|á»–|Æ |á»œ|á»š|á»¢|á»|á» /g,"O");str=str.replace(/Ã™|Ãš|á»¤|á»¦|Å¨|Æ¯|á»ª|á»¨|á»°|á»¬|á»®/g,"U");str=str.replace(/á»²|Ã|á»´|á»¶|á»¸/g,"Y");str=str.replace(/Ä/g,"D");str=str.replace(/\u0300|\u0301|\u0303|\u0309|\u0323/g,"");str=str.replace(/\u02C6|\u0306|\u031B/g,"");return str.trim()}
    function readNumberInVietnamese(number) { const units=["","má»™t","hai","ba","bá»‘n","nÄƒm","sÃ¡u","báº£y","tÃ¡m","chÃ­n"],groupUnits=[""," nghÃ¬n"," triá»‡u"," tá»·"," nghÃ¬n tá»·"," triá»‡u tá»·"];function convertBlock(e){if("000"===e)return"";let t=parseInt(e),r=parseInt(e),n=parseInt(e),i="";return t>0&&(i+=units[t]+" trÄƒm"),0===r&&n>0?i+=t>0?" linh "+units[n]:units[n]:1===r?(i+=" mÆ°á»i",5===n?i+=" lÄƒm":n>0&&(i+=" "+units[n])):r>1&&(i+=" "+units[r]+" mÆ°Æ¡i",1===n?i+=" má»‘t":5===n?i+=" lÄƒm":n>0&&(i+=" "+units[n])),i.trim()}let numStr=String(parseInt(number,10));if("0"===numStr)return"KhÃ´ng Ä‘á»“ng";let chunks=[];for(;numStr.length>0;)chunks.unshift(numStr.slice(-3)),numStr=numStr.slice(0,-3);const result=chunks.map((e,t)=>{for(;e.length<3;)e="0"+e;const r=convertBlock(e);if(!r)return"";let n=groupUnits[chunks.length-1-t];return 0===parseInt(e)&&" nghÃ¬n"===n?"":r+n}).filter(Boolean).join(" ");return(result.charAt(0).toUpperCase()+result.slice(1)).trim()+" Ä‘á»“ng"}
    
    function formatDate(dateString) {
        if (!dateString || typeof dateString !== 'string') {
            return ''; 
        }
        const parts = dateString.split(/[\/-]/);
        if (parts.length === 3) {
            let [part1, part2, year] = parts;
            if (parseInt(part1, 10) > 12) {
                return `${part1}/${part2}/${year}`;
            } else {
                return `${part2}/${part1}/${year}`;
            }
        }
        return dateString;
    }

    document.addEventListener('DOMContentLoaded', function(){
        injectHTMLStructure();
        
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('ma_hd') && urlParams.get('ma_hd').trim() !== '') {
            populateFromUrl(urlParams);
        } else {
            runDemoMode();
        }
        
        function setupActionButtons() {
            const selectBtn = document.getElementById('select-contract-btn');
            const selectContent = document.getElementById('select-contract-content');

            selectBtn.addEventListener('click', function(event) {
                event.stopPropagation();
                closeAllDropdowns(selectContent);
                selectContent.classList.toggle('show');
            });
            
            document.getElementById('select-service-action').addEventListener('click', (e) => { e.preventDefault(); renderContractTerms('service', closeAllDropdowns); });
            document.getElementById('select-dress-action').addEventListener('click', (e) => { e.preventDefault(); renderContractTerms('dress', closeAllDropdowns); });
            document.getElementById('select-family-action').addEventListener('click', (e) => { e.preventDefault(); renderContractTerms('family', closeAllDropdowns); });
            
            document.getElementById('print-action').addEventListener('click', (e) => { e.preventDefault(); renderContractTerms(currentContractType, () => window.print()); });
            document.getElementById('download-pdf-action').addEventListener('click', (e) => { e.preventDefault(); downloadAsPdf(); });
            document.getElementById('download-img-action').addEventListener('click', (e) => { e.preventDefault(); downloadAsJpg(); });
        }

        function closeAllDropdowns(exceptThisOne = null) {
            const dropdowns = document.querySelectorAll('.dropdown-content');
            dropdowns.forEach(dropdown => {
                if (dropdown !== exceptThisOne && dropdown.classList.contains('show')) {
                    dropdown.classList.remove('show');
                }
            });
        }

        window.onclick = function(event) {
            if (!event.target.matches('.action-btn')) {
                closeAllDropdowns();
            }
        }
        
        setupActionButtons();

        function populateFromUrl(params) {
             const paramToIdMap = { 
                 ten_studio: ['studio-name', 'studio-signature-name-top', 'studio-signature-name-bottom'],
                 ten_chi_nhanh: 'branch-name-main',
                 diachi_studio: 'studio-address',
                 website_studio: 'studio-website',
                 email_studio: 'studio-email',
                 dienthoai_studio: 'studio-phone',
                 zalo_studio: 'studio-zalo',
                 ma_hd: ['contract-id', 'payment-info'], 
                 ngay_hd: 'contract-date', 
                 khach_hang: 'customer-name', 
                 dien_thoai_kh: 'customer-phone', 
                 dia_chi_kh: 'customer-address', 
                 nhan_vien: 'staff-name', 
                 dien_thoai_nv: 'staff-phone', 
                 chuc_vu_nv: 'staff-title', 
                 ten_ky_kh: 'customer-signature-name', 
                 ten_ky_nv: 'staff-signature-name',
                 ngay_chup: 'shooting-date',
                 gio_chup: 'shooting-time',
                 dia_diem_chup: 'shooting-location',
                 stk: 'payment-account-number',
                 chu_tai_khoan: 'payment-account-name'
             };
            
             for (const param in paramToIdMap) {
                 if (params.has(param)) {
                     let value = decodeURIComponent(params.get(param));
                     const ids = Array.isArray(paramToIdMap[param]) ? paramToIdMap[param] : [paramToIdMap[param]];
                     
                     if (param === 'website_studio') {
                         const aElement = document.getElementById(ids);
                         if(aElement) {
                             try {
                                 const websiteData = JSON.parse(value);
                                 aElement.href = websiteData.Url;
                                 aElement.textContent = websiteData.LinkText;
                             } catch (e) {
                                 aElement.href = value;
                                 aElement.textContent = value;
                             }
                         }
                         continue;
                     }

                    if (param === 'ngay_hd' || param === 'ngay_chup') {
                        value = formatDate(value);
                    }

                     ids.forEach(id => {
                        const element = document.getElementById(id);
                         if (element) {
                            element.textContent = value;
                         }
                     });
                 }
             }
             
             /* --- START: ÄIá»€U CHá»ˆNH LOGIC HIá»‚N THá»Š LOGO --- */
             if (params.has('app_name') && params.has('logo_file')) {
                const appName = decodeURIComponent(params.get('app_name'));
                const rawLogoFile = decodeURIComponent(params.get('logo_file'));

                if (appName && rawLogoFile) {
                    // **ÄÃƒ Sá»¬A Lá»–I:** Sá»­ dá»¥ng trá»±c tiáº¿p `rawLogoFile` vÃ¬ nÃ³ chá»©a Ä‘Æ°á»ng dáº«n tÆ°Æ¡ng Ä‘á»‘i chÃ­nh xÃ¡c
                    // mÃ  AppSheet cáº§n (vÃ­ dá»¥: chi_nhanh_Images/ten_file.jpg).
                    // KhÃ´ng cáº§n cáº¯t bá» pháº§n thÆ° má»¥c.
                    const fileName = rawLogoFile; 

                    if (fileName) {
                        const finalLogoUrl = `https://www.appsheet.com/template/gettablefileurl?appName=${appName}&tableName=chi_nhanh&fileName=${encodeURIComponent(fileName)}`;
                        
                        const logoImg = document.getElementById('studio-logo-img');
                        if (logoImg) {
                            logoImg.src = finalLogoUrl;
                        }
                    }
                }
             }
             /* --- END: ÄIá»€U CHá»ˆNH LOGIC HIá»‚N THá»Š LOGO --- */
             
             document.title = "HÄ " + params.get('ma_hd') + " - " + (params.get('ten_chi_nhanh') || '');

             if (params.has('chitiet_json')) { 
                try { 
                    globalServiceData = JSON.parse(decodeURIComponent(params.get('chitiet_json')));
                } catch(e) { 
                    console.error("Error parsing JSON:", e); 
                } 
             }
             
             renderContractTerms('service'); 
             generateContractQRCode(params.get('ma_hd'));
        }

        function runDemoMode() {
             document.body.insertAdjacentHTML('beforeend', '<div style="position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg); font-size: 80pt; color: rgba(0, 0, 0, 0.05); font-weight: 700; text-transform: uppercase; pointer-events: none; z-index: 1000; display: block;">Báº¢N NHÃP</div>');
             const demoParams = new URLSearchParams();
             demoParams.set('app_name', 'AppStudio-777046908'); 
             demoParams.set('logo_file', 'chi_nhanh_Images/HC_logo_083359.jpg'); // ÄÆ°á»ng dáº«n logo vÃ­ dá»¥
             demoParams.set('ten_studio', '2H STUDIO');
             demoParams.set('ten_chi_nhanh', '2H STUDIO - SÆ N TÃ‚Y');
             demoParams.set('diachi_studio', '566 ChÃ¹a ThÃ´ng - SÆ¡n TÃ¢y - HÃ  Ná»™i');
             demoParams.set('website_studio', 'http://2hstudio.vn/');
             demoParams.set('email_studio', '2hstudio.wedding@gmail.com');
             demoParams.set('dienthoai_studio', '0854623566');
             demoParams.set('zalo_studio', '2H studio');
             demoParams.set('ma_hd', 'HD-DEMO-001');
             demoParams.set('ngay_hd', '08/31/2025'); 
             demoParams.set('khach_hang', 'KHÃCH HÃ€NG DEMO');
             demoParams.set('dien_thoai_kh', '0123456789');
             demoParams.set('dia_chi_kh', 'HÃ  Ná»™i');
             demoParams.set('nhan_vien', 'NHÃ‚N VIÃŠN DEMO');
             demoParams.set('dien_thoai_nv', '0987654321');
             demoParams.set('chuc_vu_nv', 'NhÃ¢n viÃªn');
             demoParams.set('ngay_chup', '08/30/2025');
             demoParams.set('gio_chup', '8:00 AM');
             demoParams.set('dia_diem_chup', 'Phim trÆ°á»ng Smiley Ville');
             demoParams.set('thanh_tien', '9500000');
             demoParams.set('tong_phat_sinh', '0');
             demoParams.set('khuyen_mai_tong', '500000');
             demoParams.set('phai_thanh_toan', '9000000');
             demoParams.set('da_thanh_toan', '8000000');
             demoParams.set('con_lai', '1000000');
             demoParams.set('thanh_tien_vay', '2000000');
             demoParams.set('khuyen_mai_vay', '0');
             demoParams.set('phai_thanh_toan_vay', '2000000');
             demoParams.set('ten_ky_kh', 'TÃªn KhÃ¡ch HÃ ng KÃ½');
             demoParams.set('ten_ky_nv', 'TÃªn NhÃ¢n ViÃªn KÃ½');
             demoParams.set('ma_bank', '970422');
             demoParams.set('stk', '9395966');
             demoParams.set('chu_tai_khoan', 'PHáº M VÄ‚N ÃNH');
             
             populateFromUrl(demoParams);
             
             globalServiceData = [
                { sanpham: "GÃ³i chá»¥p Premium SiÃªu cáº¥p Ä‘áº·c biá»‡t dÃ nh cho khÃ¡ch hÃ ng VIP", chitiet: "GÃ³i\\nBao gá»“m nhiá»u dÃ²ng", soluong: 1, thanhtien: 8900000, sotien_km: 500000, ghi_chu: "Bao gá»“m album\\nKhÃ´ng láº¥y quÃ  táº·ng", loai_dich_vu: "GÃ³i Chá»¥p" }, 
                { sanpham: "VÃ¡y cÆ°á»›i Lux", chitiet: "ThuÃª ngÃ y cÆ°á»›i", soluong: 1, thanhtien: 12000000, sotien_km: 500000, ghi_chu: "MÃ£ vÃ¡y V01", loai_dich_vu: "Trang phá»¥c", ngay_lay: "08/30/2025", ngay_tra: "09/02/2025" }, 
                { sanpham: "In áº£nh cá»•ng", chitiet: "Táº¥m", soluong: 1, thanhtien: 600000, sotien_km: 0, ghi_chu: "KÃ­ch thÆ°á»›c 60x90", loai_dich_vu: "Sáº£n pháº©m láº»" }
            ];
             renderContractTerms('service');
        }
        
        function populateServiceTable(filterType, contractType) {
            const table = document.querySelector('.main-content table');
            if (!table) return;

            const thead = table.querySelector('thead');
            const colgroup = table.querySelector('colgroup');
            const tableBody = table.querySelector('tbody#service-table-body');
            
            tableBody.innerHTML = '';

            if (contractType === 'dress') {
                colgroup.innerHTML = `<col style="width: 4%;"><col style="width: 16%;"><col style="width: 6%;"><col style="width: 13%;"><col style="width: 13%;"><col style="width: 13%;"><col style="width: 9%;"><col style="width: 9%;"><col style="width: 17%;">`;
                thead.innerHTML = `<tr><th>STT</th><th>Sáº£n pháº©m</th><th>Sá»‘ lÆ°á»£ng</th><th>ThÃ nh tiá»n</th><th>Sá»‘ tiá»n KM</th><th>CÃ²n láº¡i</th><th>NgÃ y láº¥y</th><th>NgÃ y tráº£</th><th>Ghi chÃº</th></tr>`;
            } else {
                colgroup.innerHTML = `<col style="width: 5%;"><col style="width: 25%;"><col style="width: 21%;"><col style="width: 6%;"><col style="width: 13%;"><col style="width: 13%;"><col style="width: 17%;">`;
                thead.innerHTML = `<tr><th>STT</th><th>Sáº£n pháº©m</th><th>Chi tiáº¿t</th><th>Sá»‘ lÆ°á»£ng</th><th>ThÃ nh tiá»n</th><th>Sá»‘ tiá»n KM</th><th>Ghi chÃº</th></tr>`;
            }
             
             const dataToDisplay = filterType 
                ? globalServiceData.filter(item => item.loai_dich_vu === filterType)
                : globalServiceData;

             dataToDisplay.forEach((item, index) => { 
                 const row = document.createElement('tr'); 
                 const thanhTienFormatted = (item.thanhtien || 0).toLocaleString('vi-VN');
                 const soTienKmFormatted = (item.sotien_km || 0).toLocaleString('vi-VN');
                 const conLaiFormatted = ((item.thanhtien || 0) - (item.sotien_km || 0)).toLocaleString('vi-VN');
                 const ghiChuFormatted = (item.ghi_chu || '').replace(/\\n/g, '<br>').replace(/\n/g, '<br>');
                 const chiTietFormatted = (item.chitiet || '').replace(/\\n/g, '<br>').replace(/\n/g, '<br>');

                 if (contractType === 'dress') {
                    const formattedNgayLay = formatDate(item.ngay_lay);
                    const formattedNgayTra = formatDate(item.ngay_tra);
                    // --- ÄIá»€U CHá»ˆNH --- */ ThÃªm class="product-cell" vÃ o cá»™t Sáº£n pháº©m
                     row.innerHTML = `<td style="text-align: center;">${index + 1}</td>
                                      <td class="product-cell"><span class="dynamic-data">${item.sanpham || ''}</span></td>
                                      <td style="text-align: center;"><span class="dynamic-data">${item.soluong || 0}</span></td>
                                      <td class="price-cell"><span class="dynamic-data">${thanhTienFormatted}</span></td>
                                      <td class="price-cell"><span class="dynamic-data">${soTienKmFormatted}</span></td>
                                      <td class="price-cell"><span class="dynamic-data">${conLaiFormatted}</span></td>
                                      <td class="date-cell"><span class="dynamic-data">${formattedNgayLay}</span></td>
                                      <td class="date-cell"><span class="dynamic-data">${formattedNgayTra}</span></td>
                                      <td><span class="dynamic-data">${ghiChuFormatted}</span></td>`;
                 } else {
                    // --- ÄIá»€U CHá»ˆNH --- */ ThÃªm class="product-cell" vÃ o cá»™t Sáº£n pháº©m
                     row.innerHTML = `<td style="text-align: center;">${index + 1}</td>
                                      <td class="product-cell"><span class="dynamic-data">${item.sanpham || ''}</span></td>
                                      <td><span class="dynamic-data">${chiTietFormatted}</span></td>
                                      <td style="text-align: center;"><span class="dynamic-data">${item.soluong || 0}</span></td>
                                      <td class="price-cell"><span class="dynamic-data">${thanhTienFormatted}</span></td>
                                      <td class="price-cell"><span class="dynamic-data">${soTienKmFormatted}</span></td>
                                      <td><span class="dynamic-data">${ghiChuFormatted}</span></td>`; 
                 }
                 tableBody.appendChild(row); 
            });
        }
        
        function generatePaymentQRCode(data, callback){const qrContainer=document.getElementById("payment-qr-container"),amount=(data.amount||0).toString().replace(/,/g,""),bankBin=data.bin||"",accountNumber=data.accountNo||"",accountName=data.accountName||"";if(!bankBin||!accountNumber){qrContainer.innerHTML='<p style="color: red; font-size: 0.9em;">Lá»—i.</p>';if(callback)callback();return}const accountNameForURL=encodeURIComponent(removeVietnameseTones(accountName).toUpperCase()),qrApiUrl=`https://img.vietqr.io/image/${bankBin}-${accountNumber}-compact.png?amount=${amount}&addInfo=${encodeURIComponent(data.info||"")}&accountName=${accountNameForURL}`,qrImage=new Image;qrImage.crossOrigin="anonymous",qrContainer.innerHTML="...",qrImage.onload=()=>{qrContainer.innerHTML="",qrContainer.appendChild(qrImage);if(callback)callback()},qrImage.onerror=()=>{qrContainer.innerHTML='<p style="color: red; font-size: 0.9em;">Lá»—i QR.</p>';if(callback)callback()},qrImage.src=qrApiUrl}
        
        function generateContractQRCode(e){const t=document.getElementById("contract-qr-container");if(!t||!e)return;const r=`https://api.qrserver.com/v1/create-qr-code/?size=65x65&data=${encodeURIComponent(e)}&qzone=1&format=svg`,n=new Image;n.src=r,n.alt=`QR Code for ${e}`,t.innerHTML="",t.appendChild(n)}
        
        function getFileNamePrefix() {
            switch(currentContractType) {
                case 'dress': return 'HD_Vay';
                case 'family': return 'HD_Baby_GD';
                default: return 'HD_Dich_Vu';
            }
        }
        
        function setButtonsState(disabled, message = '') {
            document.getElementById('print-action').disabled = disabled;
            const pdfBtn = document.getElementById('download-pdf-action');
            const imgBtn = document.getElementById('download-img-action');
            pdfBtn.disabled = disabled;
            imgBtn.disabled = disabled;
            if(disabled) {
                if (message.includes('PDF')) pdfBtn.textContent = 'Äang xá»­ lÃ½...';
                if (message.includes('IMG')) imgBtn.textContent = 'Äang xá»­ lÃ½...';
            } else {
                pdfBtn.innerHTML = 'ğŸ“„ Táº£i vá» PDF';
                imgBtn.innerHTML = 'ğŸ–¼ï¸ Táº£i HÃ¬nh áº¢nh';
            }
        }

        function downloadAsPdf() {
            const generateAndSavePdf = () => {
                setButtonsState(true, 'PDF');
                const element = document.getElementById('a4-page-content');
                const originalShadow = element.style.boxShadow;
                element.style.boxShadow = 'none';
                const filename = `${getFileNamePrefix()}_${document.getElementById('contract-id').textContent.trim()}_${document.getElementById('customer-name').textContent.trim()}.pdf`;
                
                const opt = { 
                    margin:,
                    filename: filename, 
                    image: { type: 'jpeg', quality: 0.98 }, 
                    html2canvas: { 
                        scale: 2, 
                        useCORS: true, 
                        logging: false, 
                        letterRendering: true 
                    }, 
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } 
                };

                html2pdf().from(element).set(opt).save().then(() => {
                    element.style.boxShadow = originalShadow;
                    setButtonsState(false);
                }).catch(err => {
                    console.error("PDF generation failed:", err);
                    alert("Lá»—i khi táº¡o PDF. Vui lÃ²ng thá»­ láº¡i.");
                    element.style.boxShadow = originalShadow;
                    setButtonsState(false);
                });
            };
            renderContractTerms(currentContractType, generateAndSavePdf);
        }

        function downloadAsJpg() {
            const generateAndSaveJpg = () => {
                setButtonsState(true, 'IMG');
                const element = document.getElementById('a4-page-content');
                const originalShadow = element.style.boxShadow;
                element.style.boxShadow = 'none';
                const filename = `${getFileNamePrefix()}_${document.getElementById('contract-id').textContent.trim()}_${document.getElementById('customer-name').textContent.trim()}.jpg`;
                
                const options = {
                    scale: 3,
                    useCORS: true,
                    logging: false,
                    letterRendering: true 
                };

                html2canvas(element, options).then(canvas => {
                    const link = document.createElement('a');
                    link.download = filename;
                    link.href = canvas.toDataURL('image/jpeg', 0.95);
                    link.click();
                }).catch(err => {
                    console.error("Image generation failed:", err);
                    alert("Lá»—i khi táº¡o hÃ¬nh áº£nh. Vui lÃ²ng thá»­ láº¡i.");
                }).finally(() => {
                    element.style.boxShadow = originalShadow;
                    setButtonsState(false);
                });
            };
            renderContractTerms(currentContractType, generateAndSaveJpg);
        }
        
        function renderContractTerms(type, onReadyCallback) {
            currentContractType = type;
            
            const termsContainer = document.querySelector('.terms-section');
            const titleElement = document.getElementById('main-contract-title');
            const summaryContainer = document.getElementById('summary-section-container');
            const shootingInfoTable = document.querySelector('.shooting-info-table');
            const urlParams = new URLSearchParams(window.location.search);

            if (!termsContainer || !titleElement || !summaryContainer || !shootingInfoTable) return;

            let amountForQrCode = 0;
            
            if (type === 'dress') {
                termsContainer.innerHTML = CONTRACT_TERMS_DRESS;
                titleElement.textContent = 'Há»¢P Äá»’NG CUNG Cáº¤P TRANG PHá»¤C';
                populateServiceTable('Trang phá»¥c', 'dress');
                shootingInfoTable.style.display = 'none';
                summaryContainer.innerHTML = '';
                const phaiThanhToanVay = parseFloat(urlParams.get('phai_thanh_toan_vay')?.replace(/,/g, '') || 0);
                amountForQrCode = phaiThanhToanVay;

            } else {
                shootingInfoTable.style.display = 'table';
                const defaultSummaryHTML = `
                    <table class="summary-table">
                        <tbody>
                            <tr><td>Tá»•ng tiá»n theo HÄ:</td><td style="text-align:right;"><span id="subtotal" class="dynamic-data"></span></td></tr>
                            <tr><td>Khuyáº¿n mÃ£i:</td><td style="text-align:right;"><span id="total-promotion" class="dynamic-data"></span></td></tr>
                            <tr><td>PhÃ¡t sinh:</td><td style="text-align:right;"><span id="additional-cost" class="dynamic-data"></span></td></tr>
                            <tr><td style="font-weight: 700;">Pháº£i TT:</td><td style="text-align:right; font-weight: 700;"><span id="total-due" class="dynamic-data"></span></td></tr>
                            <tr><td>ÄÃ£ TT:</td><td style="text-align:right;"><span id="amount-paid" class="dynamic-data"></span></td></tr>
                            <tr><td class="highlight-red">CÃ²n Láº¡i:</td><td style="text-align:right;"><span class="dynamic-data highlight-red" id="amount-remaining"></span></td></tr>
                            <tr><td colspan="2">(Báº±ng chá»¯: <span id="amount-in-words" class="dynamic-data"></span>)</td></tr>
                        </tbody>
                    </table>`;
                summaryContainer.innerHTML = defaultSummaryHTML;
                const financialParams = {
                    thanh_tien: 'subtotal',
                    tong_phat_sinh: 'additional-cost',
                    khuyen_mai_tong: 'total-promotion',
                    phai_thanh_toan: 'total-due',
                    da_thanh_toan: 'amount-paid',
                    con_lai: 'amount-remaining'
                };
                for(const param in financialParams){
                    const el = document.getElementById(financialParams[param]);
                    if(el){
                        const value = parseFloat(urlParams.get(param)?.replace(/,/g, '') || 0);
                        el.textContent = value.toLocaleString('vi-VN');
                    }
                }
                const conLaiRaw = (urlParams.get('con_lai') || "0").replace(/[^0-9]/g, '');
                document.getElementById('amount-in-words').textContent = readNumberInVietnamese(conLaiRaw);

                amountForQrCode = parseInt(conLaiRaw, 10);

                if (type === 'family') {
                    termsContainer.innerHTML = CONTRACT_TERMS_FAMILY;
                    titleElement.textContent = 'Há»¢P Äá»’NG BABY & GIA ÄÃŒNH';
                    populateServiceTable(null, 'family');
                } else {
                    termsContainer.innerHTML = CONTRACT_TERMS_SERVICE;
                    titleElement.textContent = 'Há»¢P Äá»’NG CUNG Cáº¤P Dá»ŠCH Vá»¤';
                    populateServiceTable(null, 'service');
                }
            }
            
            const ten_ky_kh = urlParams.get('ten_ky_kh') || (urlParams.has('ma_hd') ? '' : 'TÃªn KhÃ¡ch HÃ ng KÃ½');
            const ten_ky_nv = urlParams.get('ten_ky_nv') || (urlParams.has('ma_hd') ? '' : 'TÃªn NhÃ¢n ViÃªn KÃ½');
            const ten_studio = urlParams.get('ten_studio') || (urlParams.has('ma_hd') ? '' : '2H STUDIO');

            if (document.getElementById('customer-signature-name')) document.getElementById('customer-signature-name').textContent = ten_ky_kh;
            if (document.getElementById('staff-signature-name')) document.getElementById('staff-signature-name').textContent = ten_ky_nv;
            if (document.getElementById('studio-signature-name-top')) document.getElementById('studio-signature-name-top').textContent = ten_studio;
            if (document.getElementById('studio-signature-name-bottom')) document.getElementById('studio-signature-name-bottom').textContent = ten_studio;

            const maHd = urlParams.get('ma_hd') || '';
            const bankBin = decodeURIComponent(urlParams.get('ma_bank') || '');
            const accountNumber = decodeURIComponent(urlParams.get('stk') || '');
            const accountName = decodeURIComponent(urlParams.get('chu_tai_khoan') || '');
            generatePaymentQRCode({ 
                 bin: bankBin,
                 accountNo: accountNumber, 
                 accountName: accountName, 
                 amount: amountForQrCode, 
                 info: maHd
             }, onReadyCallback);
        }

        function injectHTMLStructure() {
             const transparentPixel = "data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=";
             document.querySelector(".header-content").innerHTML = `<header class="header"><div class="header-left"><div class="logo"><img id="studio-logo-img" src="${transparentPixel}" alt="Studio Logo" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" onerror="this.style.display='none';"></div><div class="studio-info"><h2 id="studio-name"></h2><p><strong>Äá»‹a chá»‰:</strong> <span id="studio-address"></span></p><p><strong>Website:</strong> <a id="studio-website" href="#" target="_blank"></a> | <strong>Email:</strong> <span id="studio-email"></span></p><p><strong>Äiá»‡n thoáº¡i:</strong> <span id="studio-phone"></span> | <strong>Zalo:</strong> <span id="studio-zalo"></span></p></div></div><div id="contract-qr-container" title="MÃ£ há»£p Ä‘á»“ng"></div></header>`;
             
             document.querySelector(".main-content").innerHTML = `<div><h1 class="main-title" id="main-contract-title">Há»¢P Äá»’NG CUNG Cáº¤P Dá»ŠCH Vá»¤</h1><div class="contract-meta">Sá»‘: <span id="contract-id" class="dynamic-data"></span> | NgÃ y: <span id="contract-date" class="dynamic-data"></span></div><p><strong><span id="branch-name-main"></span></strong> Gá»­i tá»›i quÃ½ khÃ¡ch hÃ ng hoÃ¡ Ä‘Æ¡n dá»‹ch vá»¥ nhÆ° sau:</p><div class="info-grid" style="display:flex; justify-content:space-between; margin-bottom:20px;"><div class="customer-info" style="width:50%;"><p><strong>KhÃ¡ch hÃ ng:</strong> <span id="customer-name" class="dynamic-data"></span></p><p><strong>Äiá»‡n thoáº¡i:</strong> <span id="customer-phone" class="dynamic-data"></span></p><p><strong>Äá»‹a chá»‰:</strong> <span id="customer-address" class="dynamic-data"></span></p></div><div class="staff-info" style="width: 40%;"><p><strong>NhÃ¢n viÃªn:</strong> <span id="staff-name" class="dynamic-data"></span></p><p><strong>Äiá»‡n thoáº¡i NV:</strong> <span id="staff-phone" class="dynamic-data"></span></p><p><strong>Chá»©c Vá»¥:</strong> <span id="staff-title" class="dynamic-data"></span></p></div></div><table style="table-layout: fixed;"><colgroup></colgroup><thead></thead><tbody id="service-table-body"></tbody></table></div><div class="summary-and-payment-wrapper"><div class="left-column"><table class="shooting-info-table"><tbody><tr><td><strong>NgÃ y chá»¥p:</strong></td><td style="text-align:right;"><span id="shooting-date" class="dynamic-data"></span></td></tr><tr><td><strong>Giá» chá»¥p:</strong></td><td style="text-align:right;"><span id="shooting-time" class="dynamic-data"></span></td></tr><tr><td><strong>Äá»‹a Ä‘iá»ƒm chá»¥p:</strong></td><td style="text-align:right;"><span id="shooting-location" class="dynamic-data"></span></td></tr></tbody></table><div class="qr-payment-section"><div class="qr-payment-content"><div class="qr-code" id="payment-qr-container"></div><div class="payment-instructions"><p style="font-weight: bold;">QUÃ‰T MÃƒ QR Äá»‚ THANH TOÃN:</p><p>- STK: <span class="dynamic-data" id="payment-account-number"></span></p><p>- Chá»§ tÃ i khoáº£n: <span class="dynamic-data" id="payment-account-name"></span></p><p>- Ná»™i dung CK: <span class="dynamic-data" id="payment-info"></span></p></div></div></div></div><div class="right-column" id="summary-section-container"></div></div><div class="terms-section"></div>`;
        }
    });
</script>
